#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2024/6/9# @Author : cyq# @File : writer# @Software: PyCharm# @Desc:import datetimefrom typing import Dict, Any, Listfrom app.mapper.ui.uiCaseResultMapper import UICaseResultMapper, UICaseTaskResultBaseMapperfrom app.mapper.ui.uiTaskMapper import UITaskMapperfrom app.mapper.user import UserMapperfrom app.mapper.file import FileMapperfrom app.model.base import FileModel, Userfrom app.model.ui import UIResultModel, UICaseModel, UITaskModel, UICaseTaskResultBaseModelfrom utils import logfrom enums.CaseEnum import Result, Statusfrom config import Configfrom utils import GenerateToolsimport osfrom play.logWriter import LogWriterfrom utils.io_sender import SocketSenderclass Writer:    """    执行db记录    """    @staticmethod    async def init_task_base_result(task: UITaskModel,                                    starter: User = None) -> UICaseTaskResultBaseModel:        """        初始化 task执行结果        :param task: UITaskModel        :param starter: 执行人        :return:        """        # if userId:        #     user = await UserMapper.get_by_id(userId)        # else:        #     user = None        result = await UICaseTaskResultBaseMapper.init_task_base_result_model(            task,            starter,        )        log.info(f'init task base result: {result}')        return result    @staticmethod    async def init_case_result(case: UICaseModel,                               user: User = None,                               baseId: int = None) -> UIResultModel:        """        初始化 用例执行结果        :param case:  用例模型        :param user:  User        :param baseId: 批量结果Base        :return: UIResultModel        """        result = await UICaseResultMapper.init_case_result_model(case, user, baseId)        return result    @staticmethod    async def write_base_result(base_result: UICaseTaskResultBaseModel):        """        回写测试结果        :param base_result: 测试结果实体        :return:        """        eTime = datetime.datetime.now()        base_result.rate_number = round(base_result.success_number / base_result.total_number * 100, 2)        base_result.end_time = eTime        base_result.total_usetime = GenerateTools.timeDiff(base_result.start_time, eTime)        base_result.status = Status.DONE        if base_result.fail_number > 0:            base_result.result = Result.FAIL        else:            base_result.result = Result.SUCCESS        return await UICaseTaskResultBaseMapper.set_base_result(base_result)    @staticmethod    async def write_case_result(case_result: UIResultModel,                                io: SocketSender,                                errorMsgMap: Dict[str, str] = None):        """        回写测试结果        :param case_result: 测试结果实体        :param io: 日志列表        :param errorMsgMap: 错误信息        :return:        """        eTime = datetime.datetime.now()        case_result.end_time = eTime        case_result.use_time = GenerateTools.timeDiff(case_result.start_time, eTime)        case_result.result = Result.SUCCESS        case_result.status = Status.DONE        case_result.running_logs = "".join(io.logs)        if errorMsgMap:            log.info(f"error_msg = {errorMsgMap}")            case_result.result = Result.FAIL            PATH_KEY = "ui_case_err_step_pic_path"            if errorMsgMap.get(PATH_KEY):                file = await Writer.write_error_file(errorMsgMap.get(PATH_KEY))                errorMsgMap[PATH_KEY] = f"{Config.UI_ERROR_PATH}{file.uid}"            for k, v in errorMsgMap.items():                setattr(case_result, k, v)        await UICaseResultMapper.set_case_result(case_result)        await io.over(case_result.uid)        await io.clear_logs()    @staticmethod    async def write_error_file(filepath: str) -> FileModel:        """        db 写入 file        :param filepath:        :return:        """        fileName = os.path.split(filepath)[-1]        file = await FileMapper.insert_file(            filePath=filepath,            fileName=fileName        )        return file    @staticmethod    async def write_assert_info(case_result: UIResultModel,                                assertsInfo: Any = None):        """        写入assertInfo        :param case_result:        :param assertsInfo:        :return:        """        case_result.assertsInfo.extend(assertsInfo)        await UICaseResultMapper.set_case_result_assertInfo(case_result.id, case_result.assertsInfo)