#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2026/1/21# @Author : cyq# @File : step_content_assert# @Software: PyCharm# @Desc:from app.mapper.interface import InterfaceContentStepResultMapperfrom app.model.interface.interfaceResultModel import InterfaceCaseStepContentResultfrom croe.interface.executor.context import CaseStepContextfrom croe.interface.executor.step_content.base import StepBaseStrategyfrom croe.interface.manager.assert_manager import AssertManagerfrom croe.interface.types import InterfaceCaseContent, VARSfrom croe.interface.starter import APIStarterfrom utils import logclass APIAssertsContentStrategy(StepBaseStrategy):    """        æ–­è¨€æ­¥éª¤æ‰§è¡Œç­–ç•¥    """    async def execute(self, step_context: CaseStepContext) -> bool:        """        æ‰§è¡Œæ–­è¨€        """        try:            case_result = step_context.execution_context.case_result            _assert_exec = AssertManager(variables=step_context.variable_manager.variables)            assert_list_info, assert_success = await _assert_exec.assert_content_list(step_context.content)            if not assert_list_info:                await step_context.starter.send(                    f"ğŸ†šğŸ†š æ–­è¨€:  âš ï¸âš ï¸ æœªé…ç½®æ–­è¨€"                )                return True            if assert_success is False:                case_result.fail_num += 1            else:                case_result.success_num += 1            await set_case_step_content_api_assert_result(                step_index=step_context.index,                interface_case_result_id=step_context.case_result_id,                interface_task_result_id=step_context.task_result_id,                assert_data=assert_list_info,                step_content=step_context.content,                starter=step_context.starter,                flag=assert_success,            )            return True        except AssertionError as e:            log.exception(e)            await step_context.starter.send(f"âš ï¸âš ï¸ æ­¥éª¤æ–­è¨€å¼‚å¸¸: {str(e)}")            return Falseasync def set_case_step_content_api_assert_result(        step_index: int,        interface_case_result_id: int,        step_content: "InterfaceCaseContent",        starter: "APIStarter",        assert_data: "VARS",        flag: bool = False,        interface_task_result_id: int = None,):    """    æ–­è¨€å†™å…¥    """    result = InterfaceCaseStepContentResult(        content_id=step_content.id,        content_type=step_content.content_type,        content_name=step_content.content_name,        content_desc=step_content.content_desc,        content_step=step_index,        content_result=flag,        interface_case_result_id=interface_case_result_id,        interface_task_result_id=interface_task_result_id,        starter_id=starter.userId,        content_asserts=assert_data,        starter_name=starter.username,    )    await InterfaceContentStepResultMapper.insert(result)