#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2026/1/21# @Author : cyq# @File : group# @Software: PyCharm# @Desc:from app.mapper.interface import InterfaceGroupMapper, InterfaceContentStepResultMapperfrom app.model.interface.InterfaceCaseStepContent import InterfaceCaseStepContentfrom app.model.interface.interfaceResultModel import InterfaceGroupResult, InterfaceCaseStepContentResultfrom croe.interface.executor.step_content.base import StepBaseStrategyfrom croe.interface.executor.context import CaseStepContextfrom croe.interface.writer import init_interface_group_result, write_interface_resultfrom enums import InterfaceAPIResultEnumfrom croe.interface.starter import APIStarterfrom utils import GenerateToolsclass APIGroupContentStrategy(StepBaseStrategy):    """    API组步骤执行策略    """    async def execute(self, step_context: CaseStepContext) -> bool:        """        执行API组步骤        """        SUCCESS = True        interface_list = await InterfaceGroupMapper.query_apis(groupId=step_context.content.target_id)        if not interface_list:            return True        start_time = GenerateTools.getTime(1)        group_result = await init_interface_group_result(            group_name=step_context.content.content_name,            group_api_num=len(interface_list),            interface_case_result_id=step_context.case_result_id        )        case_result = step_context.execution_context.case_result        for index, interface in enumerate(interface_list, start=1):            await step_context.starter.send(f"✍️✍️  EXECUTE GROUP STEP {index} : {interface}")            interface_result, success = await self.interface_executor.execute(                interface=interface,                env=step_context.execution_context.env,                case_result=case_result            )            # 写入接口结果            await write_interface_result(                interface_group_result_id=group_result.id,                **interface_result            )            if not success:                SUCCESS = False                break        if SUCCESS:            case_result.success_num += 1        else:            case_result.result = InterfaceAPIResultEnum.ERROR            case_result.fail_num += 1        await set_case_step_content_api_group_result(            step_index=step_context.index,            interface_case_result_id=step_context.case_result_id,            group_result=group_result,            step_content=step_context.content,            starter=step_context.starter,            start_time=start_time,            success=SUCCESS,        )        return SUCCESSasync def set_case_step_content_api_group_result(        step_index: int,        interface_case_result_id: int,        group_result: InterfaceGroupResult,        step_content: "InterfaceCaseStepContent",        starter: "APIStarter",        start_time: str,        success: bool = False,        interface_task_result_id: int = None,):    """    设置API组步骤结果    """    result = InterfaceCaseStepContentResult(        content_id=step_content.id,        content_type=step_content.content_type,        content_name=step_content.content_name,        content_desc=step_content.content_desc,        content_step=step_index,        content_target_result_id=group_result.id,        content_result=success,        interface_case_result_id=interface_case_result_id,        interface_task_result_id=interface_task_result_id,    )    result.starter_id = starter.userId    result.starter_name = starter.username    result.start_time = start_time    result.use_time = GenerateTools.calculate_time_difference(start_time)    await InterfaceContentStepResultMapper.insert(result)