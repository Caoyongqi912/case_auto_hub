#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2026/1/21# @Author : cyq# @File : condition# @Software: PyCharm# @Desc:from app.mapper.interface import InterfaceConditionMapper, InterfaceContentStepResultMapperfrom app.model.interface.interfaceResultModel import InterfaceCaseStepContentResultfrom croe.interface.executor.context import CaseStepContextfrom croe.interface.executor.step_content.base import StepBaseStrategyfrom croe.interface.manager.condition_manager import ConditionManagerfrom croe.interface.types import InterfaceCaseContentfrom croe.interface.writer import write_case_content_result, write_interface_resultfrom enums import InterfaceAPIResultEnumfrom croe.interface.starter import APIStarterfrom utils import GenerateToolsclass APIConditionContentStrategy(StepBaseStrategy):    """æ¡ä»¶æ­¥éª¤æ‰§è¡Œå™¨"""    async def execute(self, step_context: CaseStepContext) -> bool:        """        æ‰§è¡Œæ¡ä»¶æ­¥éª¤        """        start_time = GenerateTools.getTime(1)        condition = await InterfaceConditionMapper.get_by_id(ident=step_context.content.target_id)        condition_manager = ConditionManager(variable=step_context.variable_manager)        # æ‰§è¡Œæ¡ä»¶åˆ¤æ–­        condition_passed, content_condition = await condition_manager.invoke(condition, step_context.starter)        # å†™å…¥æ¡ä»¶ç»“æœ        condition_content_result = await set_case_step_content_api_condition_result(            step_index=step_context.index,            interface_case_result_id=step_context.case_result_id,            step_content=step_context.content,            starter=step_context.starter,            start_time=start_time,            content_condition=content_condition,            success=condition_passed,        )        case_result = step_context.execution_context.case_result        if condition_passed:            await step_context.starter.send("âœï¸âœï¸  æ‰§è¡Œæ¡ä»¶åˆ¤æ–­é€šè¿‡ ğŸ‰ğŸ‰")            # è·å–æ¡ä»¶å…³è”çš„APIåˆ—è¡¨            condition_api_list = await InterfaceConditionMapper.query_condition_apis_by_content_id(                condition.id            )            # å¦‚æœæ²¡æœ‰å…³è”APIï¼Œç›´æ¥è¿”å›æˆåŠŸ            if not condition_api_list:                condition_content_result.content_result = True                await write_case_content_result(condition_content_result)                case_result.success_num += 1                return True            # æ‰§è¡Œæ‰€æœ‰å…³è”çš„API            total_apis = len(condition_api_list)            for index, interface in enumerate(condition_api_list, start=1):                await step_context.starter.send(                    f"âœï¸âœï¸  {'-' * 20} æ‰§è¡Œæ¡ä»¶æ­¥éª¤ {index}/{total_apis}: "                    f"{interface.name} {'-' * 20}"                )                # æ‰§è¡Œå•ä¸ªæ¥å£                interface_result, success = await self.interface_executor.execute(                    interface=interface,                    env=step_context.execution_context.env,                    case_result=case_result                )                # å†™å…¥æ¥å£ç»“æœ                await write_interface_result(                    interface_condition_result_id=condition_content_result.id,                    **interface_result                )                # å¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œåœæ­¢åç»­æ‰§è¡Œ                if not success:                    await step_context.starter.send(f"âœï¸âœï¸  æ­¥éª¤ {index}/{total_apis} æ‰§è¡Œå¤±è´¥ï¼Œåœæ­¢åç»­æ‰§è¡Œ")                    case_result.result = InterfaceAPIResultEnum.ERROR                    case_result.fail_num += 1                    condition_content_result.content_result = False                    await write_case_content_result(condition_content_result)                    return False            # æ‰€æœ‰APIæ‰§è¡ŒæˆåŠŸ            condition_content_result.content_result = True            await write_case_content_result(condition_content_result)            return True        else:            # æ¡ä»¶æœªé€šè¿‡ï¼Œè·³è¿‡å­æ­¥éª¤            await step_context.starter.send("âœï¸âœï¸  æ‰§è¡Œæ¡ä»¶åˆ¤æ–­æœªé€šè¿‡ âŒâŒ  è·³è¿‡å­æ­¥éª¤")            case_result.success_num += 1            condition_content_result.content_result = True            await write_case_content_result(condition_content_result)            return Trueasync def set_case_step_content_api_condition_result(        step_index: int,        interface_case_result_id: int,        step_content: "InterfaceCaseContent",        starter: "APIStarter",        start_time: str,        content_condition: dict,        success: bool = False,        interface_task_result_id: int = None,):    """    æ¡ä»¶ ç»“æœ    """    result = InterfaceCaseStepContentResult(        content_id=step_content.id,        content_type=step_content.content_type,        content_name=step_content.content_name,        content_desc=step_content.content_desc,        content_result=success,        content_step=step_index,        content_condition=content_condition,        interface_case_result_id=interface_case_result_id,        interface_task_result_id=interface_task_result_id,    )    result.starter_id = starter.userId    result.starter_name = starter.username    result.start_time = start_time    result.use_time = GenerateTools.calculate_time_difference(start_time)    return await InterfaceContentStepResultMapper.insert(result)