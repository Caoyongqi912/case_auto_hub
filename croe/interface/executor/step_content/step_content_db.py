#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2026/1/21# @Author : cyq# @File : step_content_db# @Software: PyCharm# @Desc:from app.mapper.interface import InterfaceContentStepResultMapperfrom app.mapper.interface.interfaceCaseMapper import InterfaceCaseContentDBExecuteMapperfrom app.mapper.project.dbConfigMapper import DbConfigMapperfrom app.model.interface.interfaceResultModel import InterfaceCaseStepContentResultfrom croe.interface.executor.context import CaseStepContextfrom croe.interface.executor.step_content.base import StepBaseStrategyfrom croe.interface.types import InterfaceCaseContentfrom enums import InterfaceExtractTargetVariablesEnumfrom croe.interface.starter import APIStarterfrom utils import logfrom utils.execDBScript import ExecDBScriptclass APIDBContentStrategy(StepBaseStrategy):    """        æ•°æ®åº“æ­¥éª¤æ‰§è¡Œç­–ç•¥    """    async def execute(self, step_context: CaseStepContext) -> bool:        """        æ‰§è¡Œæ•°æ®åº“è„š&å˜é‡æå–        """        content_sql = await InterfaceCaseContentDBExecuteMapper.get_by_id(ident=step_context.content.target_id)        if not content_sql:            return True        _db = await DbConfigMapper.get_by_id(ident=content_sql.db_id)        if not _db:            await step_context.starter.send(f"æ•°æ®åº“é…ç½®ä¸å­˜åœ¨ï¼Œdb_id = {content_sql.db_id}")            return False        _db_script = await step_context.variable_manager.trans(content_sql.sql_text.strip())        log.info(f"æ‰§è¡Œå‰sqlå¤„ç†: {_db_script}")        db_script = ExecDBScript(io = step_context.starter,                                 script_str = _db_script,                                 extracts = content_sql.sql_extracts)        result = await db_script.invoke(_db.db_type, **_db.config)        await step_context.starter.send(f"ğŸ«³ğŸ«³    æ•°æ®åº“è¯»å– = {result}")        if result:            await step_context.variable_manager.add_vars(result)            await set_case_step_content_api_db_result(                step_index=step_context.index,                interface_case_result_id=step_context.case_result_id,                step_content=step_context.content,                starter=step_context.starter,                script_vars=[                    {                        InterfaceExtractTargetVariablesEnum.KEY: k,                        InterfaceExtractTargetVariablesEnum.VALUE: v,                        InterfaceExtractTargetVariablesEnum.Target: InterfaceExtractTargetVariablesEnum.ContentSQL                    }                    for k, v in result.items()                ],                interface_task_result_id=step_context.task_result_id,            )        return Trueasync def set_case_step_content_api_db_result(        step_index: int,        interface_case_result_id: int,        step_content: "InterfaceCaseContent",        starter: "APIStarter",        script_vars: "VARS",        interface_task_result_id):    result = InterfaceCaseStepContentResult(        content_id=step_content.id,        content_type=step_content.content_type,        content_name=step_content.content_name,        content_desc=step_content.content_desc,        content_result=True,        content_step=step_index,        interface_case_result_id=interface_case_result_id,        interface_task_result_id=interface_task_result_id,        starter_id=starter.userId,        script_extracts=script_vars,        starter_name=starter.username,    )    await InterfaceContentStepResultMapper.insert(result)