#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2026/1/21# @Author : cyq# @File : __init__.py# @Software: PyCharm# @Desc:from datetime import datetimefrom typing import Unionfrom app.mapper.interface import InterfaceCaseResultMapper, InterfaceGroupResultMapper, InterfaceResultMapper, \    InterfaceContentStepResultMapper, InterfaceTaskResultMapperfrom app.model.interface import InterfaceTaskfrom app.model.interface.InterfaceCaseStepContent import InterfaceCaseStepContentfrom app.model.interface.interfaceResultModel import InterfaceCaseStepContentResult, InterfaceCaseResultModel, \    InterfaceTaskResultModelfrom croe.interface.types import InterfaceCase, Env, InterfaceTaskResult, InterfaceCaseResult, InterfaceResultfrom enums import InterfaceAPIStatusEnum, InterfaceAPIResultEnumfrom croe.interface.starter import APIStarter, logfrom utils import GenerateToolsasync def write_interface_result(**kwargs) -> "InterfaceResult":    """写入api结果"""    return await InterfaceResultMapper.set_result(**kwargs)async def write_case_content_result(content_result):    """      子步骤执行 结果覆盖  """    await InterfaceContentStepResultMapper.set_result(content_result)async def write_case_result(case_result: "InterfaceCaseResult"):    """写进度"""    return await InterfaceCaseResultMapper.set_result_field(case_result)async def write_task_process(task_result: "InterfaceTaskResult"):    """写任务进度"""    return await InterfaceTaskResultMapper.set_result_field(task_result)async def write_interface_case_result(case_result: "InterfaceCaseResult"):    """写结果"""    if case_result.fail_num == 0:        case_result.result = InterfaceAPIResultEnum.SUCCESS    else:        case_result.result = InterfaceAPIResultEnum.ERROR    case_result.useTime = GenerateTools.calculate_time_difference(case_result.map['startTime'])    case_result.status = InterfaceAPIStatusEnum.OVER    return await InterfaceCaseResultMapper.set_result_field(case_result)async def init_interface_case_result(starter: "APIStarter",                                     interface_case: "InterfaceCase",                                     env: "Env",                                     task_result: Union["InterfaceTaskResult"] = None) -> "InterfaceCaseResult":    """    初始化 业务流结果对象    """    case_result = InterfaceCaseResultModel(        interfaceCaseID=interface_case.id,        interfaceCaseName=interface_case.title,        interfaceCaseUid=interface_case.uid,        interfaceCaseDesc=interface_case.desc,        interfaceCaseProjectId=interface_case.project_id,        interfaceCaseModuleId=interface_case.module_id,        total_num=interface_case.apiNum,        starterId=starter.userId,        starterName=starter.username,        status=InterfaceAPIStatusEnum.RUNNING,        running_env_id=env.id,        running_env_name=env.name    )    if task_result:        case_result.interfaceTaskResultId = task_result.id    case_result = await InterfaceCaseResultMapper.insert(case_result)    log.info(f" {interface_case} 初始化用例结果对象 = {case_result}")    return case_resultasync def init_interface_group_result(group_name: str,                                      group_api_num: int,                                      interface_case_result_id: int):    """    初始化API组结果对象    """    group_result = await InterfaceGroupResultMapper.init_model(        group_name=group_name,        group_api_num=group_api_num,        interface_case_result_id=interface_case_result_id    )    log.info(f" init_interface_group_result  = {group_result}")    return group_resultasync def init_case_step_loop_result(        step_index: int,        interface_case_result_id: int,        step_content: InterfaceCaseStepContent,        starter: APIStarter,        start_time: str,        interface_task_result_id: int = None,):    result = InterfaceCaseStepContentResult(        content_id=step_content.id,        content_type=step_content.content_type,        content_name=step_content.content_name,        content_desc=step_content.content_desc,        content_step=step_index,        interface_case_result_id=interface_case_result_id,        interface_task_result_id=interface_task_result_id,    )    result.starter_id = starter.userId    result.starter_name = starter.username    result.start_time = start_time    return await InterfaceContentStepResultMapper.insert(result)async def init_interface_task_result(interfaceTask: InterfaceTask,                                     starter: APIStarter,                                     env: "Env" = None                                     ) -> "InterfaceTaskResult":    """    初始化接口测试任务。    该异步静态方法用于初始化一个接口测试任务，并将任务相关信息以及启动者信息    组织成一个字典，最后通过 `InterfaceTaskResultMapper.init()` 方法初始化并返回    接口测试任务结果模型。    参数:    - interfaceTask: InterfaceTask 类型的对象，包含了接口测试任务的相关信息。    - starter: Starter 类型的对象，包含了启动任务的用户的相关信息。    返回:    返回一个 InterfaceTaskResultModel 类型的对象，该对象是根据传入的任务信息和    启动者信息初始化得到的接口测试任务结果模型。    """    # 创建一个字典来存储初始化任务所需的信息    init_task = InterfaceTaskResultModel(        taskId=interfaceTask.id,        taskUid=interfaceTask.uid,        taskName=interfaceTask.title,        interfaceProjectId=interfaceTask.project_id,        interfaceModuleId=interfaceTask.module_id    )    # 将启动者的相关信息添加到任务字典中    init_task.startBy = starter.startBy    init_task.starterName = starter.username    init_task.starterId = starter.userId    # 使用组织好的任务字典来初始化并返回接口测试任务结果模型    if env:        init_task.running_env_id = env.id        init_task.running_env_name = env.name    return await InterfaceTaskResultMapper.insert(init_task)async def write_interface_task_result(taskResult: "InterfaceTaskResult"):    """写任务最终结果"""    taskResult.progress = 100    taskResult.totalUseTime = GenerateTools.calculate_time_difference(taskResult.map['start_time'])    taskResult.status = InterfaceAPIStatusEnum.OVER    taskResult.end_time = datetime.now()    return await InterfaceTaskResultMapper.set_result_field(taskResult)