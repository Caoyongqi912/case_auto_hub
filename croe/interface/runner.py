#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2026/1/21# @Author : cyq# @File : runner# @Software: PyCharm# @Desc:import asynciofrom typing import Union, Optionalfrom app.mapper.interface import InterfaceMapper, InterfaceCaseMapper, InterfaceGroupMapperfrom app.mapper.interface.interfaceVarsMapper import InterfaceVarsMapperfrom app.mapper.project.env import EnvMapperfrom croe.interface.executor.context import CaseStepContext, ExecutionContextfrom croe.interface.executor.interface_executor import InterfaceExecutorfrom croe.interface.executor.step_content import get_step_strategyfrom croe.interface.manager.variable_manager import VariableManagerfrom croe.interface.writer import init_interface_case_result, write_case_result, write_interface_case_result, \    write_interface_resultfrom enums import InterfaceCaseErrorStepfrom croe.interface.starter import APIStarterfrom croe.play.starter import UIStarterfrom croe.interface.types import *from utils import logclass InterfaceRunner:    """æ¥å£å…¥å£"""    __slots__ = ("starter", "variable_manager", "interface_executor")    def __init__(self, starter: Union[UIStarter, APIStarter]):        self.starter = starter        self.variable_manager = VariableManager()        self.interface_executor = InterfaceExecutor(self.starter, self.variable_manager)    async def try_interface(self, interface_id: int, env_id: int) -> "InterfaceResultInfo":        """        æ‰§è¡Œå•ä¸ªæ¥å£è¯·æ±‚è°ƒè¯•        :param interface_id: æ¥å£id        :param env_id: ç¯å¢ƒid        :return: æ¥å£æ‰§è¡Œç»“æœ        """        interface = await InterfaceMapper.get_by_id(ident=interface_id)        env = await EnvMapper.get_by_id(ident=env_id)        result, _ = await self.interface_executor.execute(interface=interface, env=env)        return result    async def try_group(self, group_id: int, env_id: int):        """        æ‰§è¡Œæ¥å£ç»„        :param group_id ç»„ID        :param env_id  ç¯å¢ƒID        """        interfaces = await InterfaceGroupMapper.query_apis(groupId=group_id)        env = await EnvMapper.get_by_id(env_id)        results = []        for interface in interfaces:            await self.starter.send(f"âœï¸âœï¸  Execute    {interface}")            result, _ = await self.interface_executor.execute(interface=interface, env=env)            results.append(result)        return results    async def run_interface_case(self, interface_case_id: int, env: Union["Env", int], error_stop: bool,                                 task_result: Optional["InterfaceTaskResult"] = None):        """        æ‰§è¡Œæ¥å£ä¸šåŠ¡æµ ç”¨ä¾‹        :param interface_case_id: æ¥å£ç”¨ä¾‹id        :param env: ç¯å¢ƒid æˆ–è€…å¯¹è±¡        :param error_stop: æ˜¯å¦é‡åˆ°é”™è¯¯åœæ­¢æ‰§è¡Œ        :param task_result: åœ¨ä»»åŠ¡ä¸­æ‰§è¡Œæ—¶ï¼Œéœ€è¦ä¼ é€’ä»»åŠ¡æ‰§è¡Œç»“æœ        :return: æ¥å£æ‰§è¡Œç»“æœ        """        interface_case = await InterfaceCaseMapper.get_by_id(ident=interface_case_id)        log.info(f"æŸ¥è¯¢åˆ°ä¸šåŠ¡æµç”¨ä¾‹  {interface_case}")        if not interface_case:            await self.starter.send(f"æœªé€šè¿‡{interface_case_id} æ‰¾åˆ° ç›¸å…³ä¸šåŠ¡æµç”¨ä¾‹")            return await self.starter.over()        # å¾…æ‰§è¡Œçš„ case content æ­¥éª¤        case_content_steps = await InterfaceCaseMapper.query_content(case_id=interface_case.id)        await self.starter.send(f"ç”¨ä¾‹ {interface_case.title} æ‰§è¡Œå¼€å§‹ã€‚æ‰§è¡Œäºº {self.starter.username}")        await self.starter.send(f"æŸ¥è¯¢åˆ°å…³è”Step x {len(case_content_steps)} ...")        if not case_content_steps:            await self.starter.send("æ— å¯æ‰§è¡Œä¸šåŠ¡æµæ­¥éª¤ï¼Œç»“æŸæ‰§è¡Œ")            return await self.starter.over()        #   åˆå§‹åŒ– ä¸šåŠ¡æµå‰ç½®å˜é‡        await self.init_interface_case_vars(interface_case_id)        #   è§£æç¯å¢ƒ        if isinstance(env, int):            target_env = await EnvMapper.get_by_id(ident=env)        else:            target_env = env        await self.starter.send(f"âœï¸âœï¸ ä½¿ç”¨ç¯å¢ƒ {target_env}")        # é»˜è®¤ç»“æœä¸ºæˆåŠŸ        CASE_SUCCESS = True        # åˆå§‹åŒ– ä¸šåŠ¡æµç»“æœå¯¹è±¡        case_result = await init_interface_case_result(            starter=self.starter,            interface_case=interface_case,            env=target_env,            task_result=task_result        )        try:            context = ExecutionContext(                interface_case=interface_case,                env=target_env,                case_result=case_result,                task_result=task_result            )            for index, step_content in enumerate(case_content_steps, start=1):                await self.starter.send(                    f"âœï¸âœï¸ {'=' * 20} EXECUTE_STEP {index} ï¼š {step_content} {'=' * 20}"                )                case_result.progress = round(index / len(case_content_steps), 2) * 100                # æ­¥éª¤å¼€å…³ ç”¨ä¾‹è°ƒè¯•ä¸­ä½¿ç”¨ ä»»åŠ¡æ‰§è¡Œé»˜è®¤å¼€å¯                if step_content.enable == 0 and not task_result:                    await self.starter.send(f"âœï¸âœï¸  EXECUTE_STEP {index} ï¼š è°ƒè¯•ç¦ç”¨ è·³è¿‡æ‰§è¡Œ")                    continue                # å¦‚æœ flag å·²ç»æ˜¯ False ä¸”éœ€è¦é”™è¯¯åœæ­¢ï¼Œåˆ™è·³è¿‡åç»­æ­¥éª¤                if not CASE_SUCCESS and error_stop == InterfaceCaseErrorStep.STOP:                    await self.starter.send(f"â­ï¸â­ï¸  SKIP_STEP {index} ï¼š é‡åˆ°é”™è¯¯å·²åœæ­¢")                    continue                step_context = CaseStepContext(                    index=index,                    content=step_content,                    execution_context=context,                    starter=self.starter,                    variable_manager=self.variable_manager,                )                strategy = get_step_strategy(step_content.content_type, self.interface_executor)                step_success = await strategy.execute(step_context)                CASE_SUCCESS &= step_success                if not CASE_SUCCESS and interface_case.error_stop == InterfaceCaseErrorStep.STOP:                    case_result.progress = 100                    break                log.debug(f"case_result ===== {case_result}")                await write_case_result(case_result=case_result)                await self.starter.send(f"\n")            await self.starter.send(f"ç”¨ä¾‹ {interface_case.title} æ‰§è¡Œç»“æŸ")            await self.starter.send(f"{'====' * 20}")            case_result.interfaceLog = "".join(self.starter.logs)            await write_interface_case_result(case_result=case_result)            return CASE_SUCCESS, case_result        except Exception as e:            log.exception(e)            return False, case_result        finally:            await self.variable_manager.clear()            await self.starter.over(case_result.id)    async def run_interface_by_task(self, interface: "InterfaceAPI",                                    task_result: "InterfaceTaskResult",                                    retry: int = 0,                                    retry_interval: int = 0,                                    env: "Env" = None):        """        æ‰§è¡Œæ¥å£ä»»åŠ¡        :param interface: æ¥å£å¯¹è±¡        :param task_result: æ¥å£ä»»åŠ¡ç»“æœå¯¹è±¡        :param retry: é‡è¯•æ¬¡æ•°        :param retry_interval: é‡è¯•é—´éš”        :param env: ç¯å¢ƒå¯¹è±¡        :return:        """        for attempt in range(retry + 1):            result, success = await self.interface_executor.execute(interface=interface, task_result=task_result,                                                                    env=env)            # æˆåŠŸåˆ™è®°å½•ç»“æœå¹¶è¿”å›            if success:                await write_interface_result(**result)                return True            # æœ€åä¸€æ¬¡é‡è¯•å¤±è´¥ï¼Œè®°å½•ç»“æœå¹¶è¿”å›False            if attempt == retry:                await write_interface_result(**result)                await self.starter.send(f"æ¥å£ {interface} æ‰§è¡Œç»“æœ FALSE")                return False            # è¿›è¡Œé‡è¯•            await self.starter.send(f"æ¥å£ {interface} æ‰§è¡Œç»“æœ FALSE ç¬¬ {attempt + 1} æ¬¡é‡è¯•")            if retry_interval:                await asyncio.sleep(retry_interval)    async def run_interface_by_ui(self, interface: "InterfaceAPI", ui_vars: "VARS"):        """        æ‰§è¡Œæ¥å£UIä»»åŠ¡        :param interface: æ¥å£å¯¹è±¡        :param ui_vars: UIå˜é‡        :return:        """        if ui_vars:            await self.variable_manager.add_vars(ui_vars)        # env ä½¿ç”¨é»˜è®¤æ¥å£env        return await self.interface_executor.execute(interface=interface)    async def init_interface_case_vars(self, interface_case_id: int):        """        åˆå§‹åŒ–ä¸šåŠ¡æµç”¨ä¾‹å˜é‡        :param interface_case_id: ä¸šåŠ¡æµç”¨ä¾‹id        :return:        """        try:            interfaceCaseVars = await InterfaceVarsMapper.query_by(case_id=interface_case_id)            if interfaceCaseVars:                var_dict = {}                for _var in interfaceCaseVars:                    var_dict[_var.key] = await self.variable_manager.trans(_var.value)                await self.variable_manager.add_vars(var_dict)                await self.starter.send(f"ğŸ«³ğŸ«³ åˆå§‹åŒ–ä¸šåŠ¡ç”¨ä¾‹å˜é‡ = {self.variable_manager.variables}")        except Exception as e:            log.error(e)