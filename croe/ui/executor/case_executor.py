#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2026/1/29# @Author : cyq# @File : case_executor# @Software: PyCharm# @Desc:import jsonfrom app.mapper.interface import InterfaceMapperfrom app.mapper.play import PlayCaseResultMapper, PlayCaseVariablesMapper, PlayStepMapper, PlayCaseMapperfrom app.mapper.project.dbConfigMapper import DbConfigMapperfrom app.model.interface import InterfaceModelfrom app.model.playUI import PlayCase, PlayCaseResult, PlayStepfrom croe.interface.runner import InterfaceRunnerfrom croe.ui.core import BrowserManager, BrowserManagerFactoryfrom croe.ui.wait.strategy import SmartWaiterfrom croe.ui.exceptions import UIAutomationError, AssertionFailedErrorfrom croe.ui.executor.step_executor import StepExecutorfrom croe.ui.result.writer import PlayResultWriterfrom croe.ui.starter import UIStarterfrom croe.variable_manager import VariableManagerfrom utils import log, GenerateToolsfrom utils.execDBScript import ExecDBScriptclass CaseExecutor:    """    ç”¨ä¾‹æ‰§è¡Œå™¨    """    _browser_manager: BrowserManager    def __init__(self, starter: UIStarter):        self._starter = starter        self._variable = VariableManager()        self._smart_waiter = SmartWaiter()    async def run_case(self, caseId: int, error_stop: bool = True, retry_count: int = 0):        """        ç”¨ä¾‹æ‰§è¡Œ        Args:            caseId            error_stop            retry_count        """        case = await PlayCaseMapper.get_by_id(caseId)        await self._starter.send(f"å‡†å¤‡æ‰§è¡Œç”¨ä¾‹ :{case}")        try:            case_result = await PlayCaseResultMapper.init_case_result(                play_case=case,                user=self._starter            )            await self.initialize_browser()            context = await self._browser_manager.get_context()            page = await context.new_page()            steps = await PlayStepMapper.query_steps_by_caseId(case.id)            if not steps:                await self._starter.send(f"ç”¨ä¾‹ {case.title} æ²¡æœ‰æ­¥éª¤")                return case_result            # æ­¥éª¤æ‰§è¡Œ            step_executor = StepExecutor(                page=page,                variable_manager=self._variable,                starter=self._starter            )            for i, step in enumerate(steps, start=1):                if step.is_group:                    await self.execute_group_step(step=step, case_result=case_result, executor=step_executor)                else:                    await self.condition_execute(play_step=step, case_result=case_result, executor=step_executor)        except Exception as e:            log.exception(f"Case execution failed: {case.title}, error: {e}")    async def init_case_variables(self, play_case: PlayCase, case_result: PlayCaseResult):        """        åˆå§‹åŒ–å˜é‡        :param play_case: UICaseModel        :param case_result        :return:        """        try:            if variables := await PlayCaseVariablesMapper.query_by(play_case_id=play_case.id):                for case_var in variables:                    _v = await self._variable.trans(case_var.value)                    await self._variable.add_vars({case_var.key: _v})                await PlayResultWriter.write_vars_info(case_result=case_result, extract_method="INIT", step_name="INIT",                                                       varsInfo=self._variable.variables)                await self._starter.send(                    f"ðŸ«³ðŸ«³ åˆå§‹åŒ–ç”¨ä¾‹å˜é‡ = {json.dumps(self._variable.variables, ensure_ascii=False)}")        except Exception as e:            log.exception(e)            raise e    async def initialize_browser(self):        """        åˆå§‹åŒ–æµè§ˆå™¨        :return:        """        self._browser_manager = await BrowserManagerFactory.get_instance()    async def condition_execute(self, play_step: PlayStep, case_result: PlayCaseResult, executor: StepExecutor):        """        æ ¹æ®æ¡ä»¶æ‰§è¡Œæµ‹è¯•æ­¥éª¤ã€‚æ­¤å‡½æ•°è´Ÿè´£æ ¹æ®æä¾›çš„æ­¥éª¤æ¨¡åž‹å’Œæµ‹è¯•ç»“æžœæ¨¡åž‹ï¼Œæ‰§è¡Œç›¸å…³çš„APIæˆ–SQLå‰ç½®å’ŒåŽç½®åŠ¨ä½œï¼Œ        å¹¶æ ¹æ®æ­¥éª¤ç±»åž‹æ‰§è¡Œå•ä¸ªæ­¥éª¤æˆ–æ­¥éª¤ç»„ã€‚        :param play_step: UICaseStepsModelç±»åž‹çš„å®žä¾‹ï¼Œä»£è¡¨å½“å‰è¦æ‰§è¡Œçš„æµ‹è¯•æ­¥éª¤ã€‚        :param case_result: UIResultModelç±»åž‹çš„å®žä¾‹ï¼Œç”¨äºŽå­˜å‚¨æµ‹è¯•ç»“æžœã€‚        :return: æ— è¿”å›žå€¼ã€‚å¦‚æžœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°å¼‚å¸¸ï¼Œå°†æŠ›å‡ºå¼‚å¸¸ã€‚        """        try:            async def execute_actions(is_pre: int):                """                å‰åŽç½®æ‰§è¡Œ                """                if play_step.interface_a_or_b == is_pre and play_step.interface_id:                    step_api = await InterfaceMapper.get_by_id(ident=play_step.interface_id)                    await self.__execute_api(step_api, play_step, case_result)                if play_step.db_id and play_step.db_a_or_b == is_pre:                    await self.__execute_sql(play_step, case_result)            # æ‰§è¡Œ æŽ¥å£ or db            if play_step.interface_id or play_step.db_id:                await execute_actions(is_pre=1)                await executor.execute_step(play_step, case_result)                await execute_actions(is_pre=0)            else:                await executor.execute_step(play_step, case_result)        except Exception as e:            raise    async def __execute_sql(self, playStep: PlayStep, case_result: PlayCaseResult):        """        oracle æ‰§è¡Œ        :param playStep:        :return:        """        title = "å‰ç½®" if playStep.db_a_or_b else "åŽç½®"        _db = await DbConfigMapper.get_by_id(playStep.db_id)        script = await self._variable.trans(playStep.sql_script)        await self._starter.send(f'æ‰§è¡Œ{title}SQL >> {script}')        db_script = ExecDBScript(self._starter, script)        _vars = await db_script.invoke(_db.db_type, **_db.config)        if _vars:            await self._starter.send(f"SQL æå–å˜é‡ >> {_vars}")            await self._variable.add_vars(_vars)            await PlayResultWriter.write_vars_info(case_result=case_result,                                                   extract_method="SQLæå–",                                                   step_name=playStep.name,                                                   varsInfo=_vars)        return    async def __execute_api(self,                            stepApi: InterfaceModel,                            step: PlayStep,                            case_result: PlayCaseResult):        """        æ‰§è¡Œå‰åŽç½®APIè°ƒç”¨        ç›®å‰çœ‹ åªç”¨äºŽè°ƒç”¨èŽ·å¾—å˜é‡æˆ–ç€ä½¿ç”¨ã€‚ä¸Žæ–­è¨€ç»ˆæ­¢        :param stepApi: æ­¥éª¤API        :param step: UIæ­¥éª¤        :param case_result: ç”¨ä¾‹ç»“æžœå¯¹è±¡å†™å…¥        :return:        """        title = "å‰ç½®" if step.interface_a_or_b else "åŽç½®"        await self._starter.send(f'æ‰§è¡Œ{title}æŽ¥å£ >> {stepApi}')        api_runner = InterfaceRunner(self._starter)        result_info, flag = await api_runner.run_interface_by_ui(stepApi, self._variable.variables)        # å¤„ç†æå–å˜é‡        if extracts := result_info.get('extracts', []):            _ex = GenerateTools.list2dict(extracts)            await self._starter.send(f"æŽ¥å£æå–å˜é‡ >> {_ex}")            await self._variable.add_vars(_ex)            await PlayResultWriter.write_vars_info(case_result=case_result,                                                   extract_method="APIæ‰§è¡Œ",                                                   step_name=step.name,                                                   varsInfo=_ex)        # å¦‚æžœæœ‰æ–­è¨€å†™å…¥æ–­è¨€        # å¤„ç†æ–­è¨€        if asserts := result_info.get("asserts", []):            await PlayResultWriter.write_assert_info(case_result=case_result, assertsInfo=asserts)        # å¦‚æžœæŽ¥å£æ–­è¨€å¤±è´¥äº†åˆ‡ä¸è·³è¿‡ æŠ›å‡ºå¼‚å¸¸        if not flag and step.interface_fail_stop == 1:            await self._starter.send(f"æŽ¥å£æ‰§è¡Œå¤±è´¥ >> {stepApi}")            await self._starter.over(reportId=case_result.id)            raise AssertionFailedError(                message=f"æŽ¥å£æ‰§è¡Œå¤±è´¥ >> {stepApi}",            )    async def execute_group_step(self, step: PlayStep, case_result: PlayCaseResult, executor: StepExecutor):        """        æ­¥éª¤ç»„æ‰§è¡Œ        :param step:        :param case_result:        :param executor:        :return:        """        g_steps = await PlayStepMapper.query_steps_by_groupId(groupId=step.id)        log.info(f"æ­¥éª¤ç»„ >> {g_steps}")        if g_steps:            await self._starter.send(f"===== å¼€å§‹æ‰§è¡Œæ­¥éª¤ç»„ {step.name}")            for i, step in enumerate(g_steps, start=1):                log.info(f"æ­¥éª¤ç»„ >> {g_steps}")                await self.condition_execute(step, case_result, executor)            await self._starter.send(f"===== {step.name} æ‰§è¡Œæ­¥éª¤ç»„ç»“æŸ")        else:            await self._starter.send(f"æ­¥éª¤ç»„ >> {step.name} æ­¥éª¤ç»„ä¸ºç©º")