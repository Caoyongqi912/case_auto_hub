#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2026/1/29# @Author : cyq# @File : step_executor# @Software: PyCharm# @Desc:from dataclasses import dataclassfrom typing import Optional, Dict, Anyfrom playwright.async_api import Pagefrom app.model.playUI import PlayStep, PlayCaseResultfrom croe.ui.exceptions import ActionError, ConditionErrorfrom croe.ui.starter import UIStarterfrom croe.variable_manager import VariableManagerfrom utils import logfrom .method_chain import MethodChainfrom ..methods.context import StepContextclass StepExecutor:    def __init__(            self,            page: Page,            starter: UIStarter,            variable_manager: VariableManager,    ):        self._page = page        self._starter = starter        self._variable_manager = variable_manager        self._method = MethodChain.create_default_chain()    async def execute_step(self, step: PlayStep, case_result: PlayCaseResult = None) -> None:        """        执行        """        step_context = StepContext(            page=self._page,            step=step,            starter=self._starter,            variable_manager=self._variable_manager,            case_result=case_result,        )        if step.condition:            condition_met = await check_condition(step, self._variable_manager, self._starter)            if not condition_met:                await self._starter.send(f"条件不满足，跳过步骤: {step.name}")                return        try:            handled = await self._method.handle(step_context)            if not handled:                raise ActionError(f"No handler found for method: {step.method}")        except Exception as e:            log.error(f"Step execution failed: {step.name}, error: {e}")            raise    async def execute_steps(self, steps, case_result=None) -> None:        for step in steps:            await self.execute_step(step, case_result)class ConditionChecker:    """    条件检查器，用于评估步骤中的条件表达式    支持多种比较操作符：等于、不等于、大于、大于等于、小于、小于等于    """    EQ = 1  # 等于    NE = 2  # 不等于    GT = 3  # 大于    GE = 4  # 大于等于    LT = 5  # 小于    LE = 6  # 小于等于    @staticmethod    async def check(            step: PlayStep,            variable_manager: VariableManager,            io: UIStarter    ) -> bool:        """        检查步骤中的条件是否满足        Args:            step: 包含条件的测试步骤            variable_manager: 变量转换器，用于解析变量            io: 用于发送消息的IO对象        Returns:            条件是否满足的布尔值        Raises:            ConditionError: 当条件检查失败时抛出        """        condition: Dict[str, Any] = step.condition        key = await variable_manager.trans(condition['key'])        value = await variable_manager.trans(condition['value'])        operator = condition['operator']        await io.send(f"条件判断 >> key={key} & value={value}")        try:            return ConditionChecker._compare(key, value, operator)        except Exception as e:            raise ConditionError(f"Condition check failed", details=str(e))    @staticmethod    def _compare(key: str, value: str, operator: int) -> bool:        """        执行比较操作        根据操作符类型比较两个值的大小或相等性。        Args:            key: 要比较的第一个值            value: 要比较的第二个值            operator: 比较操作符类型        Returns:            比较结果的布尔值        """        try:            match operator:                case ConditionChecker.EQ:                    return key == value                case ConditionChecker.NE:                    return key != value                case ConditionChecker.GT:                    return key > value                case ConditionChecker.GE:                    return key >= value                case ConditionChecker.LT:                    return key < value                case ConditionChecker.LE:                    return key <= value                case _:                    return False        except Exception:            return Falseasync def check_condition(        step: PlayStep,        variable_manager: VariableManager,        io: UIStarter) -> bool:    """    检查条件是否满足的便捷函数    Args:        step: 包含条件的测试步骤        variable_manager: 变量转换器，用于解析变量        io: 用于发送消息的IO对象    Returns:        条件是否满足的布尔值    """    return await ConditionChecker.check(step, variable_manager, io)