#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2026/1/29# @Author : cyq# @File : locator# @Software: PyCharm# @Desc:from typing import Optionalfrom playwright.async_api import Page, Locatorfrom croe.ui.exceptions import ElementNotFoundError
from croe.ui.locator.cache import get_global_cachefrom utils import logclass ElementLocator:    """    元素定位器    提供多种元素定位方法，包括CSS选择器、文本、角色、标签、    占位符和测试ID等，支持在frame内定位元素。    """    def __init__(self, page: Page):        """        初始化元素定位器        Args:            page: Playwright页面对象        """        self._page = page    def locate(self, selector: str, frame_selector: Optional[str] = None) -> Locator:        """        使用CSS选择器定位元素        支持在frame内定位元素。如果指定了frame_selector，会先定位到frame，        然后在frame内查找目标元素。        Args:            selector: CSS选择器字符串            frame_selector: 可选的frame选择器，用于在frame内定位        Returns:            Locator: 定位到的元素对象        Raises:            ElementNotFoundError: 当元素定位失败时抛出        """        try:            if frame_selector:                frame = self._page.frame_locator(frame_selector)                return frame.locator(selector)            return self._page.locator(selector)        except Exception as e:            log.error(f"Element location failed: {selector}, error: {e}")            raise ElementNotFoundError(f"Failed to locate element: {selector}", details=str(e))    def locate_multiple(self, selector: str) -> Locator:        """        定位多个匹配的元素        使用CSS选择器定位所有匹配的元素。        Args:            selector: CSS选择器字符串        Returns:            Locator: 定位到的元素集合对象        Raises:            ElementNotFoundError: 当元素定位失败时抛出        """        try:            return self._page.locator(selector)        except Exception as e:            log.error(f"Multiple elements location failed: {selector}, error: {e}")            raise ElementNotFoundError(f"Failed to locate elements: {selector}", details=str(e))    def locate_by_text(self, text: str, exact: bool = False) -> Locator:        """        通过文本内容定位元素        根据元素的文本内容进行定位，支持精确匹配和模糊匹配。        Args:            text: 要匹配的文本内容            exact: 是否精确匹配，默认为False        Returns:            Locator: 定位到的元素对象        Raises:            ElementNotFoundError: 当元素定位失败时抛出        """        try:            return self._page.get_by_text(text, exact=exact)        except Exception as e:            log.error(f"Text location failed: {text}, error: {e}")            raise ElementNotFoundError(f"Failed to locate by text: {text}", details=str(e))    def locate_by_role(self, role: str, **kwargs) -> Locator:        """        通过ARIA角色定位元素        根据元素的ARIA角色属性进行定位，这是最推荐的无障碍定位方式。        Args:            role: ARIA角色名称，如'button'、'link'等            **kwargs: 额外的角色属性，如name、checked等        Returns:            Locator: 定位到的元素对象        Raises:            ElementNotFoundError: 当元素定位失败时抛出        """        try:            return self._page.get_by_role(role, **kwargs)        except Exception as e:            log.error(f"Role location failed: {role}, error: {e}")            raise ElementNotFoundError(f"Failed to locate by role: {role}", details=str(e))    def locate_by_label(self, text: str, exact: bool = False) -> Locator:        """        通过标签文本定位元素        根据关联的label标签的文本内容定位表单元素。        Args:            text: label标签的文本内容            exact: 是否精确匹配，默认为False        Returns:            Locator: 定位到的元素对象        Raises:            ElementNotFoundError: 当元素定位失败时抛出        """        try:            return self._page.get_by_label(text, exact=exact)        except Exception as e:            log.error(f"Label location failed: {text}, error: {e}")            raise ElementNotFoundError(f"Failed to locate by label: {text}", details=str(e))    def locate_by_placeholder(self, text: str, exact: bool = False) -> Locator:        """        通过占位符文本定位元素        根据输入框的placeholder属性进行定位。        Args:            text: placeholder文本内容            exact: 是否精确匹配，默认为False        Returns:            Locator: 定位到的元素对象        Raises:            ElementNotFoundError: 当元素定位失败时抛出        """        try:            return self._page.get_by_placeholder(text, exact=exact)        except Exception as e:            log.error(f"Placeholder location failed: {text}, error: {e}")            raise ElementNotFoundError(f"Failed to locate by placeholder: {text}", details=str(e))    def locate_by_test_id(self, test_id: str) -> Locator:        """        通过测试ID定位元素        根据元素的data-testid属性进行定位，这是专门用于测试的定位方式。        Args:            test_id: data-testid属性的值        Returns:            Locator: 定位到的元素对象        Raises:            ElementNotFoundError: 当元素定位失败时抛出        """        try:            return self._page.get_by_test_id(test_id)        except Exception as e:            log.error(f"Test ID location failed: {test_id}, error: {e}")            raise ElementNotFoundError(f"Failed to locate by test_id: {test_id}", details=str(e))async def get_locator(page: Page, step_context) -> Locator:    """    获取元素定位器    根据步骤上下文信息，获取页面元素的定位器。支持frame内元素定位。    Args:        page: Playwright Page对象        step_context: 步骤上下文，包含选择器和frame信息    Returns:        定位到的元素Locator对象    Raises:        ElementNotFoundError: 当元素定位失败时抛出    """    locator = ElementLocator(page)    selector = step_context.step.locator    frame_selector = step_context.step.iframe_name    try:        if frame_selector:            return locator.locate(selector, frame_selector)        return locator.locate(selector)    except Exception as e:        log.error(f"Failed to get locator: {selector}, error: {e}")        raise ElementNotFoundError(f"Element not found: {selector}", details=str(e))