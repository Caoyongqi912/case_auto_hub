#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2026/2/25# @Author : cyq# @File : play_db_strategy# @Software: PyCharm# @Desc:import datetimefrom app.mapper.project import DbConfigMapperfrom app.mapper.project.dbConfigMapper import CaseContentDBExecuteMapperfrom croe.play.context import StepContentContextfrom croe.play.executor.play_method.result_types import StepExecutionResultfrom croe.play.executor.step_content_strategy._base import StepBaseStrategyfrom utils import logfrom utils.execDBScript import ExecDBScriptclass PlayDBContentStrategy(StepBaseStrategy):    """    DBæ‰§è¡Œ    """    async def execute(self, step_context: StepContentContext) -> bool:        """        db        """        start_time = datetime.datetime.now()        content_sql = await CaseContentDBExecuteMapper.get_by_id(            ident=step_context.play_step_content.target_id)        if not content_sql:            return True        _db = await DbConfigMapper.get_by_id(ident=content_sql.db_id)        if not _db:            await step_context.starter.send(f"æ•°æ®åº“é…ç½®ä¸å­˜åœ¨ï¼Œdb_id = {content_sql.db_id}")            return False        _db_script = await step_context.variable_manager.trans(content_sql.sql_text.strip())        try:            db_script = ExecDBScript(io = step_context.starter,                                     script_str = _db_script,                                     extracts = content_sql.sql_extracts)            result = await db_script.invoke(_db.db_type, **_db.config)            await step_context.starter.send(f"ğŸ«³ğŸ«³    æ•°æ®åº“è¯»å– = {result}")            if result:                await step_context.variable_manager.add_vars(result)                await self.write_result(                    result=StepExecutionResult(success=True,                                               extract_data=result,                                               ),                    start_time=start_time,                    step_content=step_context                )            return True        except Exception as e:            log.exception(e)            await step_context.starter.send(f"âŒ SQLæ‰§è¡Œå¤±è´¥: {e}")            return False