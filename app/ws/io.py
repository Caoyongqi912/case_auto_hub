#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2024/8/15# @Author : cyq# @File : __init__.py# @Software: PyCharm# @Desc:from typing import Dictfrom utils import logfrom socketio import AsyncServer, ASGIAppimport fastapi_socketioclass ASGI(ASGIApp):    def __init__(self):        super().__init__(            socketio_server=io,            on_startup=setup_socketio,            on_shutdown=teardown_socketio        )class IOServerManager(AsyncServer):    def __init__(self):        self.clients = {}        super().__init__(            cors_allowed_origins="*",            async_handlers=True,            mount_location="/ws",            socketio_path = "socket.io",            async_mode='asgi'        )    async def log_emit(self, data: Dict, ns: str):        log.debug(f"ns={ns} {data}")        data['sid'] = ns        return await self.emit(            "structure_log",            data=data        )io = IOServerManager()async def setup_socketio():    log.debug("setup_socketio")async def teardown_socketio():    log.debug("teardown_socketio")@io.eventasync def connect(sid, environ):    log.debug(f"socket connect {sid}")    io.clients[sid] = None@io.eventasync def disconnect(sid):    # 移除客户端ID    if sid in io.clients:        del io.clients[sid]    log.debug(f"socket disconnect {sid}")