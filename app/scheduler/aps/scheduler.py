#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2025/4/3# @Author : cyq# @File : taskClient# @Software: PyCharm# @Desc:from typing import TypeVar, Union, Optionalfrom fastapi import Requestfrom app.exception import CommonErrorfrom app.model.base.job import AutoJobfrom app.scheduler.aps.trigger import Triggerfrom app.scheduler.aps.base import BaseSchedulerfrom config import Configfrom utils import MyLogurulog = MyLoguru().get_logger()TaskType = TypeVar('TaskType', bound=Union['PlayTask', 'InterfaceTask'])from .tasks import aps_submit_interface_taskclass TaskScheduler(BaseScheduler):    """    ui api 调度实现    """    async def add_auto_job(self, job: AutoJob):        """        添加自动化任务APS        ：param job        """        if job.job_type == 1:            return await self._add_interface_job(job=job)        elif job.job_type == 2:            return await self._add_play_job(job=job)        else:            raise ValueError(f"Invalid job type {job.job_type}")    async def modify(self, job: AutoJob):        """修改已有任务配置"""        _j = await self.get_job(job.uid)        if not _j:            log.warning(f"Job {job.id} not found, creating new one")            return await self.add_auto_job(job)        _trigger = Trigger(trigger_type=job.job_trigger_type,                           run_date=job.job_execute_time,                           cron=job.job_execute_cron,                           hours=job.job_execute_interval)        self.scheduler.modify_job(            job_id=job.uid,            name=job.job_name,            trigger=_trigger.trigger        )        return job    async def _add_interface_job(self, job: AutoJob):        """        """        _trigger = Trigger(trigger_type=job.job_trigger_type,                           run_date=job.job_execute_time,                           cron=job.job_execute_cron,                           hours=job.job_execute_interval)        log.info(f"add_interface_job Trigger : {_trigger}")        await self.add_job(            func=aps_submit_interface_task,            trigger=_trigger.trigger,            args=(job,),            job_id=job.uid,            name=job.job_name,            replace_existing=True        )    async def _add_play_job(self, job: AutoJob):        """"""async def get_scheduler(request: Request) -> Union[TaskScheduler, None]:    """依赖注入获取调度器实例"""    scheduler = request.app.scheduler    if not Config.APS:        return None    if not scheduler:        raise CommonError("Scheduler not available")    return scheduler