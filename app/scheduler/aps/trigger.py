#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2025/12/1# @Author : cyq# @File : trigger# @Software: PyCharm# @Desc:from dataclasses import dataclass, fieldfrom datetime import datetimefrom typing import Optional, Dict, Anyfrom pydantic import BaseModelfrom apscheduler.triggers.cron import CronTriggerfrom apscheduler.triggers.interval import IntervalTriggerfrom apscheduler.triggers.date import DateTriggerfrom app.model.base.job import AutoJobfrom enums import TriggerTypeEnumclass TriggerModel(BaseModel):    trigger_type: int    kw: Dict[str, Any] = field(default_factory=dict)    run_date: Optional[str] = None    cron: Optional[str] = None    hours: Optional[int] = None    minutes: Optional[int] = None    seconds: Optional[int] = None    weeks: Optional[int] = None    @property    def values(self):        if self.trigger_type == TriggerTypeEnum.CRON:            cron_value = self.kw.get("cron")            return {"cron": cron_value} if cron_value is not None else {}        elif self.trigger_type == TriggerTypeEnum.FIXED_RATE:            keys = ["seconds", "minutes", "hours", "weeks"]            return {                key: self.kw[key]                for key in keys                if key in self.kw and self.kw[key] is not None            }        elif self.trigger_type == TriggerTypeEnum.ONCE:            run_date = self.kw.get("run_date")            return {"run_date": run_date} if run_date is not None else {}        else:            return {}@dataclass(kw_only=True)class Trigger:    trigger_type: int    kw: Dict[str, Any] = field(default_factory=dict)    def __post_init__(self):        self._trigger = self._create_trigger(self.trigger_type)    def _create_trigger(self, trigger_type: int):        """创建触发器"""        trigger_model = TriggerModel(trigger_type=trigger_type, kw=self.kw)        match trigger_type:            case TriggerTypeEnum.ONCE:                return DateTrigger(**trigger_model.values)            case TriggerTypeEnum.CRON:                return _CronTrigger(**trigger_model.values)            case TriggerTypeEnum.FIXED_RATE:                return IntervalTrigger(**trigger_model.values)            case _:                raise ValueError(f"Unsupported trigger type: {trigger_type}")    @property    def trigger(self) -> CronTrigger | IntervalTrigger | DateTrigger:        return self._trigger    @property    def next_runtime(self) -> str:        """获取下一次执行时间（格式化字符串）"""        now = datetime.now()        try:            if self.trigger_type == TriggerTypeEnum.ONCE:                t = self.trigger.get_next_fire_time(previous_fire_time=None, now=now)            else:                t = self.trigger.get_next_fire_time(previous_fire_time=now, now=now)            return t.strftime("%Y-%m-%d %H:%M:%S")        except ValueError:            return "N/A"class _CronTrigger(CronTrigger):    """    Triggers when current time matches all specified time constraints,    similarly to how the UNIX cron scheduler works.    :param int|str year: 4-digit year    :param int|str month: month (1-12)    :param int|str day: day of month (1-31)    :param int|str week: ISO week (1-53)    :param int|str day_of_week: number or name of weekday (0-6 or mon,tue,wed,thu,fri,sat,sun)    :param int|str hour: hour (0-23)    :param int|str minute: minute (0-59)    :param int|str second: second (0-59)    :param datetime|str start_date: earliest possible date/time to trigger on (inclusive)    :param datetime|str end_date: latest possible date/time to trigger on (inclusive)    :param datetime.tzinfo|str timezone: time zone to use for the date/time calculations (defaults        to scheduler timezone)    :param int|None jitter: delay the job execution by ``jitter`` seconds at most    .. note:: The first weekday is always **monday**.    """    def __init__(self, cron: str):        values = cron.strip().split()        super().__init__(minute=values[0],                         hour=values[1],                         day=values[2],                         month=values[3],                         day_of_week=values[4], )if __name__ == '__main__':    tm = TriggerModel(trigger_type=TriggerTypeEnum.FIXED_RATE, kw={        "seconds": 10    })    print(tm.values)    trigger1 = Trigger(trigger_type=TriggerTypeEnum.FIXED_RATE, kw={        "seconds": 10    })    trigger2 = Trigger(trigger_type=TriggerTypeEnum.ONCE, kw={        "run_date": "2025-12-01 12:00:00"    })    trigger3 = Trigger(trigger_type=TriggerTypeEnum.CRON, kw={        "cron": "*/5 * * * *"    })    trigger4 = Trigger(trigger_type=1)    print(trigger1.next_runtime)    print(trigger2.next_runtime)    print(trigger3.next_runtime)