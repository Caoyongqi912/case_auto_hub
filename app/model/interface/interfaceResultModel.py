#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2024/11/26# @Author : cyq# @File : interfaceResultModel# @Software: PyCharm# @Desc:from sqlalchemy import Column, INTEGER, String, ForeignKey, TEXT, JSON, DATETIME, Float, DATE, BOOLEANfrom datetime import datetime, datefrom app.model import BaseModelclass InterfaceCaseStepContentResult(BaseModel):    __tablename__ = 'interface_case_step_content_result'    """    业务流 步骤 结果模型        """    interface_case_result_id = Column(INTEGER, ForeignKey("interface_case_result.id",                                                          ondelete='CASCADE'), nullable=True, comment="所属case result")    interface_task_result_id = Column(INTEGER, ForeignKey("interface_task_result.id",                                                          ondelete='CASCADE'), nullable=True, comment="所属task result")    content_id = Column(INTEGER, ForeignKey('interface_case_step_content.id', ondelete='SET NULL'), comment="步骤ID")    content_name = Column(String(250), nullable=True, comment="步骤名称")    content_desc = Column(String(250), nullable=True, comment="步骤描述")    content_step = Column(INTEGER, nullable=False, comment="步骤")    # CaseStepContentType    content_type = Column(INTEGER, nullable=False, comment="步骤类型")    # API API_GROUP  API_CONDITION    content_target_result_id = Column(INTEGER, nullable=True, comment="目标ID")    # 脚本变量    script_extracts = Column(JSON, nullable=True, comment="请求变量")    # 断言    content_asserts = Column(JSON, nullable=True, comment="断言信息")    # 等待    wait_time = Column(Float, nullable=True, comment="等待时间")    # 逻辑    content_condition = Column(JSON, nullable=True, comment="逻辑判断结果")    start_time = Column(DATETIME, default=datetime.now, comment="开始时间")    use_time = Column(String(50), nullable=True, comment="用时")    starter_id = Column(INTEGER, comment="运行人ID")    starter_name = Column(String(20), comment="运行人姓名")    content_result = Column(BOOLEAN, default=False, comment="运行结果")    def __repr__(self):        return f"Case Content Result id={self.id} type={self.content_type} content_target_result_id={self.content_target_result_id} result={self.content_result} "class InterfaceResultModel(BaseModel):    __tablename__ = 'interface_result'    interfaceID = Column(INTEGER, ForeignKey('interface.id', ondelete='CASCADE'), comment="所属用例")    interfaceName = Column(String(50), comment="用例名称")    interfaceUid = Column(String(20), comment="用例Uid")    interfaceDesc = Column(String(250), comment="用例描述")    interfaceProjectId = Column(INTEGER, comment="所属项目")    interfaceModuleId = Column(INTEGER, comment="所属模块")    interfaceEnvId = Column(INTEGER, comment="所属环境")    startTime = Column(DATETIME, default=datetime.now, comment="开始时间")    useTime = Column(String(50), nullable=True, comment="用时")    request_info = Column(JSON, nullable=True, comment="实际请求记录")    response_txt = Column(TEXT, nullable=True, comment="响应报文")    response_status = Column(INTEGER, comment="响应Code")    response_head = Column(JSON, nullable=True, comment="响应头")    request_head = Column(JSON, nullable=True, comment="请求头")    request_txt = Column(TEXT, nullable=True, comment="请求报文")    request_method = Column(String(10), nullable=True, comment="请求方法")    extracts = Column(JSON, nullable=True, comment="请求变量")    asserts = Column(JSON, nullable=True, comment="断言信息")    starterId = Column(INTEGER, comment="运行人ID")    starterName = Column(String(20), comment="运行人姓名")    result = Column(String(10), nullable=False, comment="运行结果")    interface_group_result_id = Column(INTEGER, comment="所属结果组")    interface_condition_result_id = Column(INTEGER, comment="所属条件结果组")    interface_case_result_Id = Column(INTEGER, ForeignKey("interface_case_result.id",                                                          ondelete='CASCADE'), nullable=True, comment="所属case result")    interface_task_result_Id = Column(INTEGER, ForeignKey("interface_task_result.id",                                                          ondelete='CASCADE'), nullable=True, comment="所属task result")    @property    def baseInfo(self):        return {            "id": self.id,            "interfaceID": self.interfaceID,            "interfaceName": self.interfaceName,            "interfaceUid": self.interfaceUid,            "interfaceDesc": self.interfaceDesc,            "interfaceEnvId": self.interfaceEnvId,            "request_method": self.request_method,            "useTime": self.useTime,            "response_status": self.response_status,            "result": self.result        }    def __repr__(self):        return f"<InterfaceResult(id={self.id}, interfaceID={self.interfaceID}, interfaceName={self.interfaceName},group={self.interface_group_result_id} condiiton={self.interface_condition_result_id} result={self.result})>"class InterfaceGroupResult(BaseModel):    __tablename__ = 'interface_group_result'    group_name = Column(String(20), comment="组名称")    group_api_num = Column(INTEGER, comment="组数量")    interface_case_result_id = Column(INTEGER, ForeignKey("interface_case_result.id",                                                          ondelete='CASCADE'), nullable=True, comment="所属case result")    def __repr__(self):        return f"<InterfaceGroupResult(id={self.id}, group_name={self.group_name}, >"class InterfaceConditionResult(BaseModel):    __tablename__ = 'interface_condition_result'    """    Case 步骤 断言结果    """    condition_name = Column(String(250), nullable=False, comment="断言")    assert_data = Column(JSON, nullable=True, comment="断言信息")    interface_case_result_id = Column(INTEGER, ForeignKey("interface_case_result.id",                                                          ondelete='CASCADE'), nullable=True, comment="所属case result")    def __repr__(self):        return f"<InterfaceConditionResult(id={self.id}, condition_name={self.condition_name})"class InterfaceCaseResultModel(BaseModel):    __tablename__ = 'interface_case_result'    interfaceCaseID = Column(INTEGER, ForeignKey('interface_case.id', ondelete='CASCADE'), comment="所属用例")    interfaceCaseName = Column(String(20), comment="用例名称")    interfaceCaseUid = Column(String(20), comment="用例Uid")    interfaceCaseDesc = Column(String(50), comment="用例描述")    interfaceCaseProjectId = Column(INTEGER, comment="所属项目")    interfaceCaseModuleId = Column(INTEGER, comment="所属模块")    interfaceLog = Column(TEXT, nullable=True, comment="运行日志")    running_env_id = Column(INTEGER, nullable=True, comment="运行环境")    running_env_name = Column(String(250), nullable=True, comment="运行环境")    progress = Column(Float, default=0.0, comment="进度")    startTime = Column(DATETIME, default=datetime.now, comment="开始时间")    useTime = Column(String(20), nullable=True, comment="用时")    total_num = Column(INTEGER, default=0, comment="总共数量")    success_num = Column(INTEGER, default=0, comment="成功数量")    fail_num = Column(INTEGER, default=0, comment="失败数量")    starterId = Column(INTEGER, comment="运行人ID")    starterName = Column(String(20), comment="运行人姓名")    status = Column(String(10), nullable=True, comment="运行状态")    result = Column(String(10), nullable=True, comment="运行结果")    interface_task_result_Id = Column(INTEGER, ForeignKey("interface_task_result.id",                                                          ondelete='CASCADE'), nullable=True, comment="所属task result")    def __repr__(self):        return (            f"<InterfaceCaseResult(id={self.id}, interfaceCaseID={self.interfaceCaseID}, interfaceCaseName={self.interfaceCaseName},"            f"successNum={self.success_num} failNum={self.fail_num}"            f"  result={self.result})>")class InterfaceTaskResultModel(BaseModel):    __tablename__ = 'interface_task_result'    status = Column(String(10), default="RUNNING", comment="状态")  # "RUNNING","DONE"    result = Column(String(10), nullable=True, comment="运行结果")  # SUCCESS FAIL    totalNumber = Column(INTEGER, comment="总运行数量")    successNumber = Column(INTEGER, default=0, comment="成功数量")    failNumber = Column(INTEGER, default=0, comment="失败梳理")    startBy = Column(INTEGER, nullable=False, comment="1user 2robot 3...")    starterName = Column(String(20), nullable=True, comment="运行人名称")    starterId = Column(INTEGER, nullable=True, comment="运行人ID")    totalUseTime = Column(String(20), comment="运行时间")    start_time = Column(DATETIME, default=datetime.now, nullable=True, comment="开始时间")    end_time = Column(DATETIME, nullable=True, comment="结束时间")    taskId = Column(INTEGER, ForeignKey("interface_task.id", ondelete="CASCADE"), nullable=True)    taskUid = Column(String(10), nullable=False, comment="task索引")    taskName = Column(String(20), nullable=True, comment="任务名称")    runDay = Column(DATE, default=date.today(), comment="运行日期")    progress = Column(Float, default=0, comment="进度")    running_env_id = Column(INTEGER, nullable=True, comment="运行环境")    running_env_name = Column(String(250), nullable=True, comment="运行环境")    interfaceProjectId = Column(INTEGER, comment="所属项目")    interfaceModuleId = Column(INTEGER, comment="所属模块")    def __repr__(self):        return (            f"<Task Result l(taskId='{self.taskId}', taskName='{self.taskName}', "            f"runDay='{self.runDay}',status='{self.status}'),result='{self.result})>'")    @property    def notify(self) -> dict[str, str | int]:        return {            "starter": self.starterName,            "result_id": self.id,            "result_uid": self.uid,            "task_name": self.taskName,            "task_id": self.taskId,            "task_uid": self.taskUid,            "result": self.result,            "total": self.totalNumber,            "success": self.successNumber,            "fail": self.failNumber,            "use_time": self.totalUseTime,            "start_time": self.start_time,            "end_time": self.end_time,            "project_id": self.interfaceProjectId        }