#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2024/11/20# @Author : cyq# @File : interfaceModel# @Software: PyCharm# @Desc:from app.model.basic import BaseModelfrom sqlalchemy import Column, String, INTEGER, ForeignKey, JSON, BOOLEAN, Textclass InterfaceModel(BaseModel):    """    接口表    """    __tablename__ = 'interface'    name = Column(String(100), nullable=False, comment="接口名称")    description = Column(Text, nullable=True, comment="接口描述")    status = Column(String(10), nullable=True, comment="接口状态")    level = Column(String(10), nullable=True, comment="接口等级")    url = Column(String(500), nullable=True, comment="接口地址")    method = Column(String(10), nullable=True, comment="请求类型")    params = Column(JSON, nullable=True, comment="请求参数")    headers = Column(JSON, nullable=True, comment="请求头")    body_type = Column(INTEGER, nullable=False, comment="0无 1raw 2data 3..")    raw_type = Column(String(10), nullable=True, comment="raw 类型 json text")    body = Column(JSON, nullable=True, comment="请求体")    data = Column(JSON, nullable=True, comment="表单")    asserts = Column(JSON, nullable=True, comment="断言")    extracts = Column(JSON, nullable=True, comment="响应提取")    follow_redirects = Column(INTEGER, default=0, comment="是否重定向")    connect_timeout = Column(INTEGER, nullable=True, default=6, comment="连接超时")    response_timeout = Column(INTEGER, nullable=True, default=6, comment="请求超时")    before_script = Column(String(500), nullable=True, comment="前置脚本")    before_db_id = Column(INTEGER, nullable=True, comment="前置数据库ID")    before_sql = Column(String(500), nullable=True, comment="前置sql")    before_sql_extracts = Column(JSON, nullable=True, comment="SQL提取")    after_script = Column(String(500), nullable=True, comment="后置脚本")    before_params = Column(JSON, nullable=True, comment="前置参数")    env_id = Column(INTEGER, nullable=True, comment="所属环境")    is_common = Column(INTEGER, default=1, comment="是否公共API")    enable = Column(INTEGER, default=1, comment="调试1开启0关闭")    # 组    is_group = Column(INTEGER, default=0, comment="是否是组")    group_id = Column(INTEGER, nullable=True, comment="是否是组")    # 主条件字段    is_condition = Column(INTEGER, default=0, comment="是否条件")    condition_id = Column(INTEGER, ForeignKey("interface_condition.id", ondelete="set null"),                          nullable=True, comment="条件ID")    module_id = Column(INTEGER, nullable=True, comment="所属模块")    project_id = Column(INTEGER, ForeignKey("project.id", ondelete="set null"), nullable=True, comment="所属项目")    async def init_condition(self):        self.name = "CONDITION"        self.description = "条件"        self.method = "IF"    async def init_group(self):        self.name = "GROUP"        self.description = "组"        self.method = "GROUP"    @property    def desc(self):        if len(self.description) > 10:            return self.description[:10] + "..."        return self.description    def __repr__(self):        return f"API name=\"{self.name}\" desc=\"{self.desc}\" method=\"{self.method}\" project={self.project_id} module={self.module_id}..."class InterfaceCondition(BaseModel):    """    接口条件    # 一个伪装 代理 的api 啥也不干 指向 Condition    Interface is_condition  &&  condition.id =>  id    Condition 表与 Interface 表 多对多关系  interface_condition_association    interface_condition <==> Interface    """    __tablename__ = 'interface_condition'    condition_key = Column(String(40), nullable=True, comment="条件key")    condition_value = Column(String(40), nullable=True, comment="条件value")    condition_operator = Column(INTEGER, nullable=True, comment="比较")    condition_step_num = Column(INTEGER, default=0, comment="步骤数")    def __repr__(self):        return f"<InterfaceCondition(id={self.id}, condition_key={self.condition_key} condition_value={self.condition_value} condition_operator={self.condition_operator})>"class InterfaceGroupModel(BaseModel):    """    接口表    """    __tablename__ = 'interface_group'    name = Column(String(40), nullable=False, comment="组名称")    description = Column(String(40), nullable=False, comment="组描述")    api_num = Column(INTEGER, nullable=False, default=0, comment="接口数量")    module_id = Column(INTEGER, nullable=True, comment="所属模块")    project_id = Column(INTEGER, ForeignKey("project.id", ondelete='set null'), nullable=True,                        comment="所属产品")class InterFaceCaseModel(BaseModel):    """    接口用例    """    __tablename__ = 'interface_case'    title = Column(String(40), nullable=True, comment="标题")    desc = Column(String(200), nullable=True, comment="描述")    http = Column(String(10), default="HTTP", comment='请求类型')    level = Column(String(10), comment="接口用例等级")    status = Column(String(10), comment="接口用例状态")    apiNum = Column(INTEGER, default=0, comment="接口数量")    module_id = Column(INTEGER, nullable=True, comment="所属模块")    project_id = Column(INTEGER, ForeignKey("project.id", ondelete='set null'), nullable=True,                        comment="所属产品")    error_stop = Column(INTEGER, default=0, comment="错误停止 1是 0否")    def __repr__(self):        return f"<InterFaceCase(id={self.id}, uid={self.uid} title={self.title} status={self.status})>"class InterfaceTask(BaseModel):    """    接口任务    """    __tablename__ = 'interface_task'    title = Column(String(20), unique=True, nullable=False, comment="任务标题")    desc = Column(String(100), nullable=False, comment="任务描述")    switch = Column(BOOLEAN, default=False, comment="开关")    status = Column(String(20), nullable=True, default="WAIT", comment="任务状体")    level = Column(String(20), nullable=False, comment="任务等级")    total_cases_num = Column(INTEGER, nullable=False, default=0, comment='cases用例个数')    total_apis_num = Column(INTEGER, nullable=False, default=0, comment='api用例个数')    project_id = Column(INTEGER, ForeignKey("project.id"), nullable=True,                        comment="所属产品")    is_auto = Column(INTEGER, default=0, comment="定时执行1是0否")    cron = Column(String(29), nullable=True, comment="corn")    retry = Column(INTEGER, default=0, comment='重试次数')    parallel = Column(INTEGER, default=0, comment='并行能力')    push_id = Column(INTEGER, nullable=True, comment="推送")    module_id = Column(INTEGER, nullable=True, comment="所属模块")    def __repr__(self):        return f"<InterfaceTask(id={self.id}, uid={self.uid} title={self.title})>"class InterfaceVariables(BaseModel):    """    用例前置变量    """    __tablename__ = "interface_case_variables"    key = Column(String(40), nullable=False, unique=True, comment="key")    value = Column(String(100), nullable=False, comment="value")    case_id = Column(INTEGER, ForeignKey('interface_case.id', ondelete="cascade"),                     nullable=False, comment="所属用例")    def __repr__(self):        return (            f"<InterfaceVariables(key='{self.key}', value='{self.value}', caseId='{self.case_id}')>"        )