#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2024/6/20# @Author : cyq# @File : project# @Software: PyCharm# @Desc:import asyncioimport jsonimport timefrom pickle import FALSEfrom fastapi import APIRouter, Dependsfrom app.controller import Authenticationfrom app.model.base import Userfrom app.response import Responsefrom app.mapper.project import ProjectMapper, GlobalVariableMapperfrom app.mapper.project.env import EnvMapperfrom app.schema.base import InsertProjectSchema, PageProjectSchema, UpdateProjectSchemafrom app.schema.base.env import InsertEnvSchema, UpdateEnvSchema, PageEnvSchema, DeleteEnvSchema, FilterByEnvSchema, \    EnvFieldfrom app.schema.interface import AddGlobalSchema, PageGlobalSchema, SetGlobalSchema, UpdateGlobalSchemafrom common import get_redisfrom utils import logrouter = APIRouter(prefix="/project", tags=["项目"])@router.post("/insert_variable", description="添加全局变量")async def insert_variable(info: AddGlobalSchema, cr: User = Depends(Authentication())):    g = await GlobalVariableMapper.save(        creator_user=cr,        **info.model_dump()    )    return Response.success(g)@router.post("/page_variable", description="分页 变量")async def page_variable(info: PageGlobalSchema, _: User = Depends(Authentication())):    data = await GlobalVariableMapper.page_query(**info.model_dump(exclude_unset=True, exclude_none=True))    return Response.success(data)@router.get("/query_variable", description="全部变量")async def query_variable(_: User = Depends(Authentication())):    data = await GlobalVariableMapper.query_all()    return Response.success(data)@router.post("/remove_variable", description="删除变量")async def remove_variable(info: SetGlobalSchema, _: User = Depends(Authentication())):    await GlobalVariableMapper.delete_by_uid(info.uid)    return Response.success()@router.post("/update_variable", description="更新全局变量")async def update_variable(info: UpdateGlobalSchema, ur: User = Depends(Authentication())):    await GlobalVariableMapper.update_by_uid(        updateUser=ur,        **info.model_dump()    )    return Response.success()@router.get("/query", description="查询所有项目")async def query_project(_: User = Depends(Authentication())):    """    查询所有项目    :return:    """    data = await ProjectMapper.query_all()    return Response.success(data)@router.get("/queryInfoCount", description="查询所有项目配置数量")async def query_project_info(project_id:int,_: User = Depends(Authentication())):    """    查询所有项目    :return:    """    data = await ProjectMapper.query_info_count(project_id)    return Response.success(data)@router.post("/page", description="分页")async def page_project(pageInfo: PageProjectSchema, _=Depends(Authentication())):    info = await ProjectMapper.page_query(**pageInfo.model_dump(        exclude_unset=True,        exclude_none=True    ))    return Response.success(info)@router.post('/insert', description="添加项目")async def insert_project(project: InsertProjectSchema,                         auth=Depends(Authentication(isAdmin=True))):    await ProjectMapper.insert_project(        **project.model_dump(),        creatorUser=auth    )    return Response.success()@router.post('/update', description="修改项目")async def update_project(project: UpdateProjectSchema,                         auth=Depends(Authentication(isAdmin=True))):    await ProjectMapper.update_by_uid(        **project.model_dump(            exclude_unset=True,            exclude_none=True        ),        updateUser=auth    )    return Response.success()@router.post('/delete', description="删除项目")async def delete_project(project: UpdateProjectSchema,                         _=Depends(Authentication(isAdmin=True))):    await ProjectMapper.delete_by_id(        **project.model_dump(            exclude_unset=True,            exclude_none=True        )    )    return Response.success()@router.post("/env/insert", description="添加环境")async def insert_env(env: InsertEnvSchema, auth=Depends(Authentication())):    await EnvMapper.save(        **env.model_dump(),        creator_user=auth    )    return Response.success()@router.post("/env/update", description="添加环境")async def insert_env(env: UpdateEnvSchema, auth=Depends(Authentication())):    await EnvMapper.update_by_id(        **env.model_dump(),        updateUser=auth    )    return Response.success()@router.get("/env/queryBy", description="查询环境")async def query_env_by(env: FilterByEnvSchema = Depends(), _=Depends(Authentication())):    envs = await EnvMapper.query_by(**env.model_dump(        exclude_unset=True,        exclude_none=True    ))    return Response.success(envs)@router.get("/env/detail", description="查询环境")async def get_env_by_id(env: EnvField = Depends(), _=Depends(Authentication())):    env = await EnvMapper.get_by_id(ident=env.id)    return Response.success(env)@router.get("/env/query", description="查询所有环境")async def query_env_by(_=Depends(Authentication())):    envs = await EnvMapper.query_all()    return Response.success(envs)@router.post("/env/page", description="环境分页")async def page_env(pageInfo: PageEnvSchema, _=Depends(Authentication())):    envs = await EnvMapper.page_query(**pageInfo.model_dump(        exclude_unset=True,        exclude_none=True    ))    return Response.success(envs)@router.post("/env/remove", description="删除环境")async def remove_env(env: DeleteEnvSchema, _=Depends(Authentication())):    await EnvMapper.delete_by_id(ident=env.id)    return Response.success()@router.post("/start-task")async def start_task(user=Depends(Authentication())):    from utils import GenerateTools    from app.sse import sse    # taskid = GenerateTools.uid()    # await sse.subscriber(user.uid)    # log.info(taskid)    asyncio.create_task(        run_background_task(user_id=user.uid)    )    return Response.success()@router.get("/listen")async def listen_messages(user_id: str = "user_001"):    """用户监听自己的消息"""    from app.sse import sse    async def generate():        # 获取用户的队列        queue = await sse.connect_user(user_id)        # 持续发送消息        while True:            message = await queue.get()            # SSE 格式：data: {json}\n\n            print(message)            yield f"data: {message}\n\n"    from fastapi.responses import StreamingResponse    return StreamingResponse(        generate(),        media_type="text/event-stream"    )# 3. 后台任务async def run_background_task(user_id: str):    """后台执行任务，发送消息给用户"""    from app.sse import sse    # 发送开始消息    await sse.send_to_user(user_id, {"type": "start", "msg": "任务开始"})    # 模拟任务执行    for i in range(1, 11):        await asyncio.sleep(1)  # 等待1秒        # 发送进度        await sse.send_to_user(user_id, f'处理第{i}步')    # 发送完成消息    await sse.send_to_user(user_id, {"type": "complete", "msg": "任务完成"})