#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2025/4/8# @Author : cyq# @File : aps_job# @Software: PyCharm# @Desc:from fastapi import APIRouter, Dependsfrom app.controller import Authenticationfrom app.mapper.interface import InterfaceTaskMapperfrom app.mapper.project.jobMapper import JobMapperfrom app.model.base import Userfrom app.response import Responsefrom app.scheduler.aps.scheduler import hubSchedulerfrom app.schema.base import ApsSwitchSchema, InsertJobSchema, UpdateJobSchema, GetOrRemoveJobSchema, PageJobSchemafrom utils import logrouter = APIRouter(prefix="/aps/job", tags=['自动化任务'])@router.post("/add", description="添加任务")async def add_job(data: InsertJobSchema, user: User = Depends(Authentication())):    """    添加任务    """    job = await JobMapper.save(**data.model_dump(), creator_user=user)    if job.job_enabled:        await hubScheduler.add_auto_job(            job        )    return Response.success()@router.post("/update", description="更新")async def update_job(data: UpdateJobSchema, user: User = Depends(Authentication())):    """    修改    """    log.debug(f"=========={data}")    job = await JobMapper.update_by_uid(**data.model_dump(        exclude_unset=True,        exclude_none=True,    ), updateUser=user)    await hubScheduler.modify(job)    return Response.success(job)@router.post("/delete", description="删除任务")async def delete_job(data: GetOrRemoveJobSchema, _: User = Depends(Authentication()),                     ):    """    删除任务    """    await JobMapper.delete_by_uid(data.job_id)    await hubScheduler.remove_job(data.job_id)    return Response.success()@router.post("/pageJobs", description="任务列表")async def page_jobs(page_data: PageJobSchema, _: User = Depends(Authentication())):    data = await JobMapper.page_by_module(**page_data.model_dump(        exclude_unset=True,        exclude_none=True,    ))    log.info(f"任务列表: {data}")    job_item = data.pop("items")    final_item = []    if job_item:        for job in job_item:            job_map = job.to_dict()            aps_job = await hubScheduler.get_job(job.uid)            if aps_job:                job_map["next_run_time"] = aps_job.next_run_time            final_item.append(job_map)    data["items"] = final_item    return Response.success(data)@router.get("/queryJobTasks", description="获取TASK")async def query_tasks(jobId: str, _: User = Depends(Authentication())):    data = await JobMapper.query_tasks_by_job_id(jobId)    return Response.success(data)@router.get("/switch", description="开启与暂停")async def set_switch(job_id: str, enable: bool, user: User = Depends(Authentication())):    await JobMapper.update_by_uid(        updateUser=user,        uid=job_id,        job_enabled=enable    )    await hubScheduler.switch_job(        job_id=job_id,        enable=enable    )    return Response.success()## @router.get("/list", description="任务列表")# async def query_job(_: User = Depends(Authentication())):#     jobs = await scheduler.get_all_jobs()#     log.info(f"任务列表: {jobs}")#     tasks = []#     ui_job_ids = []#     api_job_ids = []#     for job in jobs:#         if job.id.startswith("UI_"):#             ui_job_ids.append(job.id.split("UI_")[-1])#         elif job.id.startswith("API_"):#             api_job_ids.append(job.id.split("API_")[-1])#         else:#             continue##     api_tasks = await InterfaceTaskMapper.query_by_in_clause(target="uid", list_=api_job_ids)#     ui_tasks = await PlayTaskMapper.query_by_in_clause(target="uid", list_=ui_job_ids)##     for at in api_tasks:#         t = await scheduler.job_next_run_time(f"API_{at.uid}")#         tasks.append({**at.to_dict(), "next": t, "tag": "API"})#     for ut in ui_tasks:#         t = await scheduler.job_next_run_time(f"UI_{ut.uid}")#         tasks.append({**ut.to_dict(), "next": t, "tag": "UI"})#     return Response.success(tasks)### @router.post('/set_switch', description="开关任务")# async def set_switch(data: ApsSwitchSchema, _: User = Depends(Authentication()), scheduler=Depends(get_scheduler)):#     job_id = f"{data.tag}_{data.uid}"##     if data.tag == "UI":#         # 检查是否开启任务#         task = await PlayTaskMapper.get_by_uid(data.uid)#         if data.switch and not task.is_auto:#             return Response.error("请先配置自动任务")#         await PlayTaskMapper.update_by_uid(updateUser=_, **{"uid": data.uid, "switch": data.switch})#     else:#         # 检查是否开启任务#         task = await InterfaceTaskMapper.get_by_uid(data.uid)#         if data.switch and not task.is_auto:#             return Response.error("请先配置自动任务")#         await InterfaceTaskMapper.update_by_uid(updateUser=_, **{"uid": data.uid, "switch": data.switch})#     await scheduler.set_switch(job_id, data.switch)#     return Response.success()# @router.get("/jobText/start")# async def start(name):#     from play.debugger import Tester#     tests = asyncio.create_task(Tester().run_task(1, 2), name=name)#     return Response.success()## @router.get("/jobText/stop")# async def stop(name):#     tasks = asyncio.all_tasks()#     for t in tasks:#         if t.get_name() == name:#             t.cancel()#             # 等待任务取消完成#             try:#                 await t#             except asyncio.CancelledError:#                 print("Task was cancelled and has finished")#     return Response.success()