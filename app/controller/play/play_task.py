#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2025/7/23# @Author : cyq# @File : play_task# @Software: PyCharm# @Desc:import asynciofrom fastapi import APIRouter, Dependsfrom app.controller import Authenticationfrom app.mapper.play import PlayCaseResultMapperfrom app.model.base import Userfrom app.response import Responsefrom app.schema.play.playTaskSchema import *from app.mapper.play.playTaskMapper import PlayTaskMapper, PlayTaskResultMapperrouter = APIRouter(prefix="/play/task", tags=['自动化任务'])@router.get("/basicDetail", description="任务信息")async def taskDetail(taskId: int, _: User = Depends(Authentication())):    """    获取任务信息    :param taskId:    :param _:user    :return:    """    data = await PlayTaskMapper.get_by_id(ident=taskId)    return Response.success(data)@router.get("/queryAssociationCase", description="查询用例")async def queryAssociationCase(taskId: int, _: User = Depends(Authentication())):    """    获取任务信息    :param taskId:    :param _:user    :return:    """    data = await PlayTaskMapper.query_case(taskId)    return Response.success(data)@router.post("/insertAssociationCase", description="添加关联用例")async def insertAssociationCase(assInfo: PlayAssociationCase, _: User = Depends(Authentication())):    await PlayTaskMapper.association_cases(**assInfo.model_dump())    return Response.success()@router.post("/removeAssociationCase", description="移除关联用例")async def removeAssociationCase(assInfo: PlayRemoveAssociationCase, _: User = Depends(Authentication())):    await PlayTaskMapper.remove_association_case(**assInfo.model_dump())    return Response.success()@router.post("/reorderAssociationCase", description="关联用例执行排序")async def reorderAssociationCase(assInfo: PlayAssociationCase, _: User = Depends(Authentication())):    await PlayTaskMapper.reorder_association_case(**assInfo.model_dump())    return Response.success()@router.post("/page", description="任务分页")async def pageTask(pageInfo: PagePlayTaskSchema, _: User = Depends(Authentication())):    data = await PlayTaskMapper.page_by_module(**pageInfo.model_dump(        exclude_none=True    ))    return Response.success(data)@router.post("/handleExecute", description="添加任务")async def handleExecute(taskInfo: GetPlayTaskByIDSchema, user: User = Depends(Authentication())):    from common.redis_worker_pool import r_pool, register_play_task_handle    task = await PlayTaskMapper.get_by_id(ident=taskInfo.taskId)    await r_pool.submit_to_redis(func=register_play_task_handle,                                 job_id=task.uid,                                 job_name=task.title,                                 job_kwargs={                                     "task_id": task.id,                                     "user": user,                                 }                                 )    return Response.success()@router.post("/executeJenkins", description="jenkins执行任务")async def runTaskByJenkins(data: GetPlayTaskByIDSchema):    from common.redis_worker_pool import r_pool, register_play_task_robot    task = await PlayTaskMapper.get_by_id(ident=data.taskId)    await r_pool.submit_to_redis(func=register_play_task_robot,                                 job_id=task.uid,                                 job_name=task.title,                                 job_kwargs={                                     "task_id": task.id,                                 }                                 )    return Response.success()@router.post("/baseReport/page", description="任务报告分页")async def pageTaskReport(pageInfo: PlayPageTaskReportSchema, _: User = Depends(Authentication())):    """    任务报告分页    :param pageInfo:    :param _:    :return:    """    data = await PlayTaskResultMapper.page_query(**pageInfo.model_dump(exclude_none=True, exclude_unset=True))    return Response.success(data)@router.get("/resultDetail", description="任务报告")async def resultDetail(resultId: int, _: User = Depends(Authentication())):    """    任务报告分页    :param resultId:    :param _:    :return:    """    data = await PlayTaskResultMapper.get_by_id(ident=resultId)    return Response.success(data)@router.get("/removeTaskResult", description="任务报告")async def removeTaskResult(resultId: str, _: User = Depends(Authentication())):    """    任务报告分页    :param resultId:    :param _:    :return:    """    data = await PlayTaskResultMapper.delete_by_uid(uid=resultId)    return Response.success(data)@router.get("/clearTaskResult", description="清空任务报告")async def clearTaskResult(taskId: int, _: User = Depends(Authentication())):    """    clearTaskResult    :param taskId:    :param _:    :return:    """    data = await PlayTaskResultMapper.clear_result(taskId)    return Response.success(data)@router.get("/queryCaseResultByTaskId", description="任务报告")async def queryCaseResultByTaskId(resultId: int, _: User = Depends(Authentication())):    """    任务报告    :param resultId:    :param _:    :return:    """    data = await PlayCaseResultMapper.query_by(task_result_id=resultId)    return Response.success(data)