#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2024/11/20# @Author : cyq# @File : interfaceApi# @Software: PyCharm# @Desc:from fastapi import APIRouter, Depends, Form, UploadFile, File, BackgroundTasksfrom app.controller import Authenticationfrom app.mapper.interface import InterfaceScriptMapper, InterfaceMapperfrom app.model.base import Userfrom app.response import Responsefrom app.schema.interface import *from app.schema.interface.interfaceApiSchema import TryScriptSchemafrom interface.execScript import ExecScriptForInterfacefrom interface.fileReader import FileReaderfrom interface.io_sender import APISocketSenderfrom interface.starter import Starterfrom utils import MyLoguru, logfrom interface.runner import InterFaceRunnerfrom utils.curlTrans import CurlConverterLOG = MyLoguru().get_logger()router = APIRouter(prefix="/interface", tags=['自动化接口步骤'])@router.post("/setInterfaceModule", description="设置接口部分")async def set_interface_Module(info: SetInterfacesModuleSchema, auth=Depends(Authentication())):    await InterfaceMapper.set_interfaces_modules(**info.dict())    return Response.success()@router.post("/upload", description="上传")async def upload_api(valueType: str = Form(...),  # 用 Form 来接受表单参数                     project_id: str = Form(...),                     module_id: str = Form(...),                     env_id: str = Form(...),                     api_file: UploadFile = File(...),  # 上传文件,                     cr: User = Depends(Authentication())):    """    创建 目录    创建 interface    :param valueType:    :param project_id:    :param module_id:    :param env_id:    :param api_file:    :param cr:    :return:    """    content = await FileReader.readUploadFile(valueType, api_file)    await InterfaceMapper.upload(project_id=project_id,                                 module_id=module_id,                                 env_id=env_id,                                 creator=cr,                                 apis=content)    return Response.success(content)@router.post("/insert", description="添加步骤")async def insert_interface_Api(ApiInfo: AddInterfaceApiSchema, auth=Depends(Authentication())):    api = await InterfaceMapper.save(        creatorUser=auth,        **ApiInfo.dict())    return Response.success(api)@router.get("/detail", description="接口信息")async def detail_interface(interfaceId: int, _=Depends(Authentication())):    inter = await InterfaceMapper.get_by_id(interfaceId)    return Response.success(inter)@router.post("/copy", description="复制")async def detail_interface(interfaceId: CopyInterfaceApiSchema, copyer=Depends(Authentication())):    inter = await InterfaceMapper.copy_api(        is_common=True,        apiId=interfaceId.id,        creator=copyer    )    return Response.success(inter)@router.post("/tryScript", description="调试脚本")async def try_script(scriptInfo: TryScriptSchema, auth=Depends(Authentication())):    sc = ExecScriptForInterface()    data = sc.exec_script(scriptInfo.script)    return Response.success(data)@router.get("/queryBy", description="批量查询")async def query_by_interface(inter: InterfaceApiFieldSchema, auth=Depends(Authentication())):    inters = await InterfaceMapper.get_by(**inter.dict(        exclude_unset=True,        exclude_none=True,    ))    return Response.success(inters)@router.post("/page", description="分页查询")async def page_interface(inter: PageInterfaceApiSchema, _=Depends(Authentication())):    inters = await InterfaceMapper.page_by_module(        **inter.dict(            exclude_unset=True,            exclude_none=True        )    )    return Response.success(inters)@router.post("/pageNoModule", description="分页查询")async def page_interface_no_module(inter: PageInterfaceApiSchema, _=Depends(Authentication())):    inters = await InterfaceMapper.page_query(        module_id=None,        **inter.dict(            exclude_unset=True,            exclude_none=True        )    )    return Response.success(inters)@router.post("/update", description="修改接口")async def update_interface(inter: InterfaceApiFieldSchema, auth=Depends(Authentication())):    await InterfaceMapper.update_by_id(**inter.dict(        exclude_unset=True,    ), updateUser=auth)    return Response.success()@router.post("/remove", description="删除")async def remove_interface(inter: RemoveInterfaceApiSchema, _=Depends(Authentication())):    await InterfaceMapper.remove(inter.id)    return Response.success()@router.post("/try", description="调试")async def try_interface_Api(interId: TryAddInterfaceApiSchema, user=Depends(Authentication())):    """api 执行 """    logger = APISocketSender(user.uid)    _starter = Starter(user)    resp = await InterFaceRunner(        starter=_starter,        io=logger    ).try_interface(interface=interId.interfaceId)    LOG.info(f"{resp}")    return Response.success([resp])@router.get("/query/script_doc", description="Api可用脚本")async def get_interface_script_doc(_: User = Depends(Authentication())):    docs = await InterfaceScriptMapper.query_all()    return Response.success(docs)@router.post("/transCurl", description="转换curl")async def tansCurlScript(script: CurlSchema, _: User = Depends(Authentication())):    """转换curl"""    try:        info = CurlConverter(script.script).parse_curl()        return Response.success(info)    except Exception as e:        return Response.error("解析失败、请检查")@router.post("/debugPerf", description="调试执行")async def debug_perf(info: PerfSchema, background_tasks: BackgroundTasks, user: User = Depends(Authentication()), ):    io = APISocketSender(user.uid)    _starter = Starter(user)    interfaceInfo = await InterFaceRunner(        starter=_starter,        io=io    ).get_interface(interfaceId=info.interfaceId)    log.debug(interfaceInfo)    from common.locustClient import start_locust    try:        background_tasks.add_task(            start_locust,            domain=interfaceInfo.pop("host"),            method=interfaceInfo.pop("method"),            url=interfaceInfo.pop("url"),            request_info=interfaceInfo,            users=info.perf_user,            spawn_rate=info.perf_spawn_rate,            duration=info.perf_duration,            io=io        )    except Exception as e:        raise e    return Response.success()