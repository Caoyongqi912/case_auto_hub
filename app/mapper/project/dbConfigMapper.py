#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2025/2/17# @Author : cyq# @File : dbConfigMapper# @Software: PyCharm# @Desc:from sqlalchemy.ext.asyncio import AsyncSessionfrom app.exception import CommonErrorfrom app.mapper import Mapperfrom app.model import async_sessionfrom app.model.base import Userfrom app.model.base.db_config import DBConfigfrom app.model.interface.InterfaceCaseStepContent import DBExecuteModelfrom enums import DBTypeEnumfrom croe.interface.starter import APIStarterfrom common import RedisClient, OracleClient, MySqlClientfrom utils.execDBScript import ExecDBScriptclass DbConfigMapper(Mapper[DBConfig]):    __model__ = DBConfig    @classmethod    async def try_script(cls, db_id: int, script: str, user: User):        """        调试 db 脚本        """        io = APIStarter(user)        execScript = ExecDBScript(io=io, script_str=script, onlySearch=True)        try:            async with async_session() as session:                dbConfig = await cls.get_by_id(db_id, session)                return await execScript.invoke(dbConfig.db_type, **dbConfig.config)        except Exception as e:            raise e    @staticmethod    async def test_connect(db_type: int, db_host, db_port, db_username, db_password, db_database, **kwargs):        match db_type:            case DBTypeEnum.MYSQL:                return await MySqlClient.connect(db_host, db_port, db_username, db_password, db_database)            case DBTypeEnum.ORACLE:                return await OracleClient.test_connect(db_host, db_port, db_username, db_password, db_database)            case DBTypeEnum.REDIS:                return await RedisClient.connect(db_host, db_port, db_username, db_password, db_database)            case _:                raise CommonError("不支持类型")class CaseContentDBExecuteMapper(Mapper[DBExecuteModel]):    """接口&play 用例数据库执行Mapper"""    __model__ = DBExecuteModel    @classmethod    async def init_empty(cls, creator_user: User, session: AsyncSession = None) -> DBExecuteModel:        """        初始化空的数据库执行对象        :param creator_user: 创建人        :param session: 会话对象        :return: 数据库执行对象        """        if session:            return await cls.save(creator_user=creator_user, session=session)        else:            async with async_session() as session:                return await cls.save(creator_user=creator_user, session=session)