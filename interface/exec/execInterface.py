#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2026/1/20# @Author : cyq# @File : execInterface# @Software: PyCharm# @Desc:import jsonfrom typing import Tuple, Mapping, Any, Optional, List, Dictfrom app.mapper.project.dbConfigMapper import DbConfigMapperfrom enums import InterfaceExtractTargetVariablesEnumfrom interface.middleware import HttpxMiddlewarefrom interface.starter import APIStarterfrom interface.types import *from play.starter import UIStarterfrom utils import logfrom utils.execDBScript import ExecDBScriptfrom utils.variableTrans import VariableTransclass InterfaceExecutor:    def __init__(            self,            vars_manager: VariableTrans,            env: Env,            case_result: Optional[InterfaceCaseResult],            task_result: Optional[InterfaceTaskResult],            starter: APIStarter | UIStarter    ):        """            env (Env, optional): è¿è¡Œç¯å¢ƒ. Defaults to None.            case_result (InterfaceCaseResult, optional): ä¸šåŠ¡æµç»“æœå¯¹è±¡. Defaults to None.            task_result (InterfaceTaskResult, optional): ä»»åŠ¡ç»“æœå¯¹è±¡. Defaults to None.        """        self.vars = vars_manager        self.env = env        self.case_result = case_result        self.task_result = task_result        self.starter = starter        self.sender = HttpxMiddleware(vars_manager, starter)    async def execute(self, interface: InterfaceAPI, temp_vars: Optional[VARS] = None):        """æ¥å£æ‰§è¡Œ        Args:            interface (InterfaceAPI): æ¥å£å¯¹è±¡            temp_vars (VARS, optional): ä¸´æ—¶å˜é‡. Defaults to None.        Returns:            Tuple[Mapping[str, Any], bool] ç»“æœï¼Œæ˜¯å¦æˆåŠŸ        """        interface_temp_vars = await prepare_temp_variables(temp_vars)    async def _execute_pre_operations(self,interface:InterfaceAPI):        ...    async def __exec_before_params(self, before_params: List[Dict[str, Any]] = None):        """å¤„ç†å‰ç½®å‚æ•°        æ·»åŠ åˆ°å…¨å±€å˜é‡        è¿”å›å±€åŸŸå˜é‡        """        if before_params:            values = await self.vars.trans(before_params)            log.debug(f"before params {values}")            await self.vars.add_vars(values)            _vars = [                {                    **item,                    InterfaceExtractTargetVariablesEnum.Target: InterfaceExtractTargetVariablesEnum.BeforeParams                }                for item in values            ]            return _vars        return []    async def __exec_before_sql(self, interface: InterfaceAPI):        """        æ‰§è¡Œå‰ç½®sql æ“ä½œ        ## Select            sql:str            - select username from user => [{username:xxx}{username:xxx}][0]            - select username as un  from user => [{un:xxx}{un:xxx}][0]            sql_extracts: [{key:username,jp:$[0].username},{key:username,jp:$[1].username}]            - select username from user => [{username:xxx}{username:xxx}]            ==>  [{username:xx},{username:xx}]        ## Update        """        # ä¸æ‰§è¡Œ        if not interface.before_sql or not interface.before_db_id:            return []        _db = await DbConfigMapper.get_by_id(interface.before_db_id)        if not _db:            log.warning(f"æœªæ‰¾åˆ°æ•°æ®åº“é…ç½® ID: {interface.before_db_id}")            return []        script = await self.vars.trans(interface.before_sql.strip())        db_script = ExecDBScript(self.starter, script, interface.before_sql_extracts)        res = await db_script.invoke(_db.db_type, **_db.config)        await self.vars.add_vars(res)        await self.starter.send(f"ğŸ«³ğŸ«³    æ•°æ®åº“è¯»å– = {json.dumps(res, ensure_ascii=False)}")        if res:            _vars = [                {                    InterfaceExtractTargetVariablesEnum.KEY: k,                    InterfaceExtractTargetVariablesEnum.VALUE: v,                    InterfaceExtractTargetVariablesEnum.Target: InterfaceExtractTargetVariablesEnum.BeforeSQL                }                for k, v in res.items()            ]            return _vars        return []    async def __exec_script(self, script: str,                            target=InterfaceExtractTargetVariablesEnum.BeforeScript) -> VARS:        """        æ‰§è¡Œè„šæœ¬        Args:            script (f): è„šæœ¬å†…å®¹            target (_type_, optional): Defaults to InterfaceExtractTargetVariablesEnum.BeforeScript.        Returns:            VARS: æå–å˜é‡        """        if script:            exe = ExecSafeScript()            _extracted_vars = exe.execute(script)            await self.vars.add_vars(_extracted_vars)            await self.starter.send(f"ğŸ«³ğŸ«³  è„šæœ¬ = {json.dumps(_extracted_vars, ensure_ascii=False)}")            _vars = [                {                    InterfaceExtractTargetVariablesEnum.KEY: k,                    InterfaceExtractTargetVariablesEnum.VALUE: v,                    InterfaceExtractTargetVariablesEnum.Target: target                }                for k, v in _extracted_vars.items()            ]            return _vars        return []async def prepare_temp_variables(temp_vars: Optional[VARS]) -> VARS:    """å‡†å¤‡ä¸´æ—¶å˜é‡"""    temp_variables = []    if temp_vars:        if isinstance(temp_vars, list):            temp_variables.extend(temp_vars)        else:            temp_variables.append(temp_vars)    return temp_variables