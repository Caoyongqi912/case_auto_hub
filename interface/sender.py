#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2024/11/22# @Author : cyq# @File : sender# @Software: PyCharm# @Desc:from typing import Any, Dict, Listfrom httpx import Responsefrom app.model.interface import InterfaceModelfrom utils.httpxClient import HttpxClientfrom utils import MyLoguruimport relog = MyLoguru().get_logger()class Sender(HttpxClient):    async def __call__(self, interface: InterfaceModel, **kwargs) -> Response:        """        :param interface        :return:        """        _request_data = {            "headers": interface.headers,            "params": interface.params,            "data": interface.data,            "json": interface.body,            "timeout": interface.responseTimeout        }        return await super().__call__(method=interface.method.lower(),                                      url=interface.url,                                      **_request_data)    async def transform_target(self, target: Any):        """        参数转换        数据转换        """        # 如果单纯字符串        if isinstance(target, str):            return await self._transformStr(target)        # 如果是字典        if isinstance(target, dict):            return await self._transFormObj(target)        # 如果是列表        if isinstance(target, list):            return await self._transFormList(target)    async def _transformStr(self, target: str) -> str:        """        字符串替换        """        if target.startswith("{{") and target.endswith("}}"):            extractKey = target[2:-2]            if extractKey in self.variables:                newValue = self.variables[extractKey]                return newValue            else:                return target        # elif target.startswith("${"):        #     funcStr = re.findall(r"\$\{(.*?)\}", target)        #     if funcStr:        #         funcStr = funcStr[0]        #     ex = ExecFuncManager(funcStr, "KEY")        #     obj = ex.execFunc()        #     return obj.get("KEY")        else:            pattern = r"{{(.*?)}}"            newValue = re.sub(pattern, lambda match: str(self.variables.get(match.group(1), "")), target)            return newValue    async def _transFormObj(self, target: Dict[str, Any]) -> Dict[str, Any]:        """        字典替换        :param target        """        transformed_target = {}        for key, value in target.items():            # 如果value是字符串            if isinstance(value, str):                newValue = await self._transformStr(value)                transformed_target[key] = newValue            # 如果还是字典            elif isinstance(value, dict):                newObj = await self._transFormObj(value)                transformed_target[key] = newObj            # 如果是列表            elif isinstance(value, list):                newList = await self._transFormList(value)                transformed_target[key] = newList            else:                transformed_target[key] = value        return transformed_target    async def _transFormList(self, target: List[Any]) -> List[Any]:        """        列表替换        """        transformed_list = []        for i in target:            if isinstance(i, str):                newValue = await self._transformStr(i)                transformed_list.append(newValue)            elif isinstance(i, dict):                transformed_list.append(await self._transFormObj(i))            elif isinstance(i, list):                transformed_list.append(await self._transFormList(i))            else:                transformed_list.append(i)        return transformed_list