#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2024/11/26# @Author : cyq# @File : writer# @Software: PyCharm# @Desc:from typing import Mapping, Any, List, Tuplefrom httpx import Responsefrom app.mapper.interface import InterfaceResultMapper, InterfaceTaskResultMapper, InterfaceCaseResultMapperfrom app.model.base import Userfrom app.model.interface import InterfaceModel, InterFaceCaseModel, InterfaceCaseResultModel, InterfaceTask, \    InterfaceTaskResultModelfrom enums import InterfaceAPIResultEnum, InterfaceAPIStatusEnumfrom utils import MyLogurufrom datetime import datetimelog = MyLoguru().get_logger()def calculate_time_difference(a: str):    # 将字符串格式的时间转换为 datetime 对象    time_a = datetime.strptime(a, '%Y-%m-%d %H:%M:%S')    # 获取当前时间    time_b = datetime.now()    # 计算时间差    time_diff = time_b - time_a    # 获取小时、分钟、秒和微秒    seconds = time_diff.total_seconds()    hours = int(seconds // 3600)    minutes = int((seconds % 3600) // 60)    seconds = seconds % 60    # 格式化秒数到小数点后 2 位    formatted_time = f"{hours:02}:{minutes:02}:{seconds:05.2f}"    return formatted_timeclass InterfaceAPIWriter:    @staticmethod    async def init_interface_case_result(starter: User,                                         interfaceCase: InterFaceCaseModel,                                         taskId: int = None) -> InterfaceCaseResultModel:        """        初始化        :param taskId:  run by task        :param starter:        :param interfaceCase:        :return:        """        init_info = dict(            interfaceCaseID=interfaceCase.id,            interfaceCaseName=interfaceCase.title,            interfaceCaseUid=interfaceCase.uid,            interfaceCaseDesc=interfaceCase.desc,            interfaceCaseProjectId=interfaceCase.project_id,            interfaceCasePartId=interfaceCase.part_id,            total_num=interfaceCase.apiNum,            starterId=starter.id,            starterName=starter.username,            status=InterfaceAPIStatusEnum.RUNNING        )        if taskId:            init_info['interface_task_result_Id'] = taskId        return await InterfaceCaseResultMapper.init(**init_info)    @staticmethod    async def init_interface_task(interfaceTask: InterfaceTask, startBy: User | int) -> InterfaceTaskResultModel:        init_task = dict(            taskId=interfaceTask.id,            taskUid=interfaceTask.uid,            taskName=interfaceTask.title        )        if isinstance(startBy, User):            init_task['startBy'] = 1            init_task['starterName'] = startBy.username            init_task['starterId'] = startBy.id        else:            init_task['startBy'] = startBy        return await InterfaceTaskResultMapper.init(**init_task)    @staticmethod    async def write_process(caseResult: InterfaceCaseResultModel):        """写进度"""        return await InterfaceCaseResultMapper.set_result_field(caseResult)    @staticmethod    async def set_interface_result_info(            starter: User,            interface: InterfaceModel,            response: Response | str = None,            asserts: List[Mapping[str, Any]] = None,            caseResult: InterfaceCaseResultModel = None,            variables: List[Mapping[str, Any]] = None,            taskResult: InterfaceTaskResultModel = None) -> Tuple[Mapping[str, Any], bool]:        """        写结果        :param starter： 执行人        :param interface: 接口实体        :param response: 响应结果对象        :param variables: 变量        :param asserts:断言信息        :param taskResult: 任务结果实例        :param caseResult: 用例结果实例        """        flag = True        _interfaceBaseInfo = dict(            interfaceID=interface.id,            interfaceName=interface.name,            interfaceUid=interface.uid,            interfaceDesc=interface.desc,            starterId=starter.id,            starterName=starter.username,            interfaceProjectId=interface.project_id,            interfacePartId=interface.part_id,            interfaceEnvId=interface.env_id        )        if taskResult:            _interfaceBaseInfo['interface_task_result_Id'] = taskResult.id        if caseResult:            _interfaceBaseInfo['interface_case_result_Id'] = caseResult.id        _response = dict()        _response['extracts'] = variables        _response['asserts'] = asserts        _response['result'] = InterfaceAPIResultEnum.SUCCESS        if isinstance(response, str):            _response['response_status'] = 500            _response['response_txt'] = response            _response['result'] = InterfaceAPIResultEnum.ERROR            flag = False        elif isinstance(response, Response):            _response[                'result'] = InterfaceAPIResultEnum.SUCCESS if response.status_code == 200 else InterfaceAPIResultEnum.ERROR            _response['response_status'] = response.status_code            _response['response_txt'] = response.text            _response['response_head'] = dict(response.headers)            _response['request_head'] = dict(response.request.headers)            _response['request_method'] = response.request.method.upper()            _response['useTime'] = response.elapsed.total_seconds()            flag = True if response.status_code == 200 else False        if asserts:            for i in asserts:                if i['result'] is False:                    flag = False                    _response['result'] = InterfaceAPIResultEnum.ERROR                    break        return {**_interfaceBaseInfo, **_response}, flag    @staticmethod    async def write_interface_result(**kwargs):        """写入api结果"""        return await InterfaceResultMapper.set_result(**kwargs)    @staticmethod    async def write_interface_case_result(caseResult: InterfaceCaseResultModel):        """写结果"""        caseResult.useTime = calculate_time_difference(caseResult.map['startTime'])        caseResult.status = InterfaceAPIStatusEnum.OVER        return await InterfaceCaseResultMapper.set_result_field(caseResult)    @staticmethod    async def write_interface_task_result(taskResult: InterfaceTaskResultModel):        """写任务最终结果"""        taskResult.progress = 100        taskResult.totalUseTime = calculate_time_difference(taskResult.map['start_time'])        taskResult.status = InterfaceAPIStatusEnum.OVER        taskResult.end_time = datetime.now()        return await InterfaceTaskResultMapper.set_result_field(taskResult)    @staticmethod    async def write_task_process(task_result: InterfaceTaskResultModel):        """写任务进度"""        return await InterfaceTaskResultMapper.set_result_field(task_result)