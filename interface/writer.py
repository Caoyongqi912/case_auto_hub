#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2024/11/26# @Author : cyq# @File : writer# @Software: PyCharm# @Desc:from dataclasses import dataclassfrom typing import Mapping, Any, List, Tuple, Dict, Optionalfrom httpx import Responsefrom app.mapper.interface import InterfaceResultMapper, InterfaceTaskResultMapper, InterfaceCaseResultMapper, \    InterfaceContentStepResultMapperfrom app.model.base import EnvModelfrom app.model.interface import InterfaceModel, InterFaceCaseModel, InterfaceCaseResultModel, InterfaceTask, \    InterfaceTaskResultModelfrom app.model.interface.InterfaceCaseStepContent import InterfaceCaseStepContentfrom app.model.interface.interfaceResultModel import InterfaceCaseStepContentResult, InterfaceResultModel, \    InterfaceGroupResultfrom enums import InterfaceAPIResultEnum, InterfaceAPIStatusEnumfrom interface.starter import APIStarterfrom utils import MyLogurufrom datetime import datetimelog = MyLoguru().get_logger()def calculate_time_difference(a: str):    # 将字符串格式的时间转换为 datetime 对象    time_a = datetime.strptime(a, '%Y-%m-%d %H:%M:%S')    # 获取当前时间    time_b = datetime.now()    # 计算时间差    time_diff = time_b - time_a    # 获取小时、分钟、秒和微秒    seconds = time_diff.total_seconds()    hours = int(seconds // 3600)    minutes = int((seconds % 3600) // 60)    seconds = seconds % 60    # 格式化秒数到小数点后 2 位    formatted_time = f"{hours:02}:{minutes:02}:{seconds:05.2f}"    return formatted_time@dataclassclass InitInterfaceCaseResult:    """    :param env: 运行环境    :param starter:    :param interface_case:    """    starter: "APIStarter"    interface_case: "InterFaceCaseModel"    env: "EnvModel"    task: Optional['InterfaceTaskResultModel'] = Noneclass InterfaceAPIWriter:    @staticmethod    async def init_interface_case_result(params: InitInterfaceCaseResult) -> InterfaceCaseResultModel:        """        初始化 业务流结果对象        :param params:  InitInterfaceCaseResult        """        case_result = InterfaceCaseResultModel(            interfaceCaseID=params.interface_case.id,            interfaceCaseName=params.interface_case.title,            interfaceCaseUid=params.interface_case.uid,            interfaceCaseDesc=params.interface_case.desc,            interfaceCaseProjectId=params.interface_case.project_id,            interfaceCaseModuleId=params.interface_case.module_id,            total_num=params.interface_case.apiNum,            starterId=params.starter.userId,            starterName=params.starter.username,            status=InterfaceAPIStatusEnum.RUNNING,            running_env_id=params.env.id,            running_env_name=params.env.name        )        if params.task:            case_result.interface_task_result_Id = params.task.id        return await InterfaceCaseResultMapper.insert(case_result)    @staticmethod    async def init_interface_task(interfaceTask: InterfaceTask,                                  starter: APIStarter,                                  env: EnvModel = None                                  ) -> InterfaceTaskResultModel:        """        初始化接口测试任务。        该异步静态方法用于初始化一个接口测试任务，并将任务相关信息以及启动者信息        组织成一个字典，最后通过 `InterfaceTaskResultMapper.init()` 方法初始化并返回        接口测试任务结果模型。        参数:        - interfaceTask: InterfaceTask 类型的对象，包含了接口测试任务的相关信息。        - starter: Starter 类型的对象，包含了启动任务的用户的相关信息。        返回:        返回一个 InterfaceTaskResultModel 类型的对象，该对象是根据传入的任务信息和        启动者信息初始化得到的接口测试任务结果模型。        """        # 创建一个字典来存储初始化任务所需的信息        init_task = InterfaceTaskResultModel(            taskId=interfaceTask.id,            taskUid=interfaceTask.uid,            taskName=interfaceTask.title,            interfaceProjectId=interfaceTask.project_id,            interfaceModuleId=interfaceTask.module_id        )        # 将启动者的相关信息添加到任务字典中        init_task.startBy = starter.startBy        init_task.starterName = starter.username        init_task.starterId = starter.userId        # 使用组织好的任务字典来初始化并返回接口测试任务结果模型        if env:            init_task.running_env_id = env.id            init_task.running_env_name = env.name        return await InterfaceTaskResultMapper.insert(init_task)    @staticmethod    async def write_process(case_result: InterfaceCaseResultModel):        """写进度"""        return await InterfaceCaseResultMapper.set_result_field(case_result)    @staticmethod    async def set_interface_result_info(            startTime: str,            starter: APIStarter,            interface: InterfaceModel,            request_info: Dict[str, Any] = None,            response: Response | str = None,            asserts: List[Mapping[str, Any]] = None,            case_result: InterfaceCaseResultModel = None,            variables: List[Mapping[str, Any]] = None,            task_result: InterfaceTaskResultModel = None) -> Tuple[Mapping[str, Any], bool]:        """        设置接口结果信息        :param startTime: 请求时间记录        :param starter: 执行人        :param interface: 接口实体        :param request_info: 接口请求体        :param response: 响应结果对象        :param asserts: 断言信息        :param case_result: 用例结果实例        :param variables: 变量        :param task_result: 任务结果实例        :return: 结果信息和执行状态        """        # 构建基础信息        _interfaceBaseInfo = {            'startTime': startTime,            'interfaceID': interface.id,            'interfaceName': interface.name,            'interfaceUid': interface.uid,            'interfaceDesc': interface.desc,            'starterId': starter.userId,            'starterName': starter.username,            'interfaceProjectId': interface.project_id,            'interfaceModuleId': interface.module_id,            'interfaceEnvId': interface.env_id,            'request_info': request_info        }        # 添加关联ID        if task_result:            _interfaceBaseInfo['interface_task_result_Id'] = task_result.id        if case_result:            _interfaceBaseInfo['interface_case_result_Id'] = case_result.id        # 初始化响应信息        _response = {            'extracts': variables or [],            'asserts': asserts or [],            'result': InterfaceAPIResultEnum.SUCCESS,            'request_method': interface.method.upper()        }        # 处理响应结果        flag = True        if isinstance(response, str):            # 字符串响应表示错误            _response.update({                'response_status': 500,                'response_txt': response,                'result': InterfaceAPIResultEnum.ERROR            })            flag = False        elif isinstance(response, Response):            # Response对象处理            is_success = response.status_code == 200            _response.update({                'result': InterfaceAPIResultEnum.SUCCESS if is_success else InterfaceAPIResultEnum.ERROR,                'response_status': response.status_code,                'response_txt': response.text,                'response_head': dict(response.headers),                'request_head': dict(response.request.headers),                'useTime': round(response.elapsed.total_seconds() * 1000, 2)  # 转成ms            })            flag = is_success        # 处理断言结果        if asserts:            has_failed_assert = any(assert_item.get('result') is False for assert_item in asserts)            if has_failed_assert:                flag = False                _response['result'] = InterfaceAPIResultEnum.ERROR        return {**_interfaceBaseInfo, **_response}, flag    @staticmethod    async def write_interface_result(**kwargs) -> InterfaceResultModel:        """写入api结果"""        return await InterfaceResultMapper.set_result(**kwargs)    @staticmethod    async def write_interface_case_result(case_result: InterfaceCaseResultModel):        """写结果"""        if case_result.fail_num == 0:            case_result.result = InterfaceAPIResultEnum.SUCCESS        else:            case_result.result = InterfaceAPIResultEnum.ERROR        case_result.useTime = calculate_time_difference(case_result.map['startTime'])        case_result.status = InterfaceAPIStatusEnum.OVER        return await InterfaceCaseResultMapper.set_result_field(case_result)    @staticmethod    async def write_interface_task_result(taskResult: InterfaceTaskResultModel):        """写任务最终结果"""        taskResult.progress = 100        taskResult.totalUseTime = calculate_time_difference(taskResult.map['start_time'])        taskResult.status = InterfaceAPIStatusEnum.OVER        taskResult.end_time = datetime.now()        return await InterfaceTaskResultMapper.set_result_field(taskResult)    @staticmethod    async def write_task_process(task_result: InterfaceTaskResultModel):        """写任务进度"""        return await InterfaceTaskResultMapper.set_result_field(task_result)    @staticmethod    async def set_case_step_content_api_result(            step_index: int,            interface_case_result_id: int,            step_content: InterfaceCaseStepContent,            interface_result: InterfaceResultModel,            flag: bool = False,            interface_task_result_id: int = None,    ):        """        用例步骤结果写入        """        result = InterfaceCaseStepContentResult(            content_id=step_content.id,            content_type=step_content.content_type,            content_name=step_content.content_name,            content_desc=step_content.content_desc,            content_target_result_id=interface_result.id,            content_step=step_index,            content_result=flag,            starter_id=interface_result.starterId,            starter_name=interface_result.starterName,            start_time=interface_result.startTime,            use_time=interface_result.useTime,            interface_case_result_id=interface_case_result_id,            interface_task_result_id=interface_task_result_id,        )        await InterfaceContentStepResultMapper.insert(result)    @staticmethod    async def set_case_step_content_api_group_result(            step_index: int,            interface_case_result_id: int,            group_result: InterfaceGroupResult,            step_content: InterfaceCaseStepContent,            starter: APIStarter,            start_time: str,            flag: bool = False,            interface_task_result_id: int = None,    ):        """        API GROUP        """        result = InterfaceCaseStepContentResult(            content_id=step_content.id,            content_type=step_content.content_type,            content_name=step_content.content_name,            content_desc=step_content.content_desc,            content_step=step_index,            content_target_result_id=group_result.id,            content_result=flag,            interface_case_result_id=interface_case_result_id,            interface_task_result_id=interface_task_result_id,        )        result.starter_id = starter.userId        result.starter_name = starter.username        result.start_time = start_time        result.use_time = calculate_time_difference(start_time)        await InterfaceContentStepResultMapper.insert(result)    @staticmethod    async def set_case_step_content_api_condition_result(            step_index: int,            interface_case_result_id: int,            step_content: InterfaceCaseStepContent,            starter: APIStarter,            start_time: str,            content_condition: dict,            flag: bool = False,            interface_task_result_id: int = None,    ):        """        条件 结果        """        result = InterfaceCaseStepContentResult(            content_id=step_content.id,            content_type=step_content.content_type,            content_name=step_content.content_name,            content_desc=step_content.content_desc,            content_result=flag,            content_step=step_index,            content_condition=content_condition,            interface_case_result_id=interface_case_result_id,            interface_task_result_id=interface_task_result_id,        )        result.starter_id = starter.userId        result.starter_name = starter.username        result.start_time = start_time        result.use_time = calculate_time_difference(start_time)        return await InterfaceContentStepResultMapper.insert(result)    @staticmethod    async def set_case_step_content_api_assert_result(            step_index: int,            interface_case_result_id: int,            step_content: InterfaceCaseStepContent,            starter: APIStarter,            assert_data: dict,            flag: bool = False,            interface_task_result_id: int = None,    ):        """        断言写入        """        result = InterfaceCaseStepContentResult(            content_id=step_content.id,            content_type=step_content.content_type,            content_name=step_content.content_name,            content_desc=step_content.content_desc,            content_step=step_index,            content_result=flag,            interface_case_result_id=interface_case_result_id,            interface_task_result_id=interface_task_result_id,            starter_id=starter.userId,            content_asserts=assert_data,            starter_name=starter.username,        )        await InterfaceContentStepResultMapper.insert(result)    @staticmethod    async def set_case_step_content_api_script_vars_result(            step_index: int,            interface_case_result_id: int,            step_content: InterfaceCaseStepContent,            starter: APIStarter,            script_vars: Any,            interface_task_result_id: int = None,    ):        """        脚本变量写入        """        result = InterfaceCaseStepContentResult(            content_id=step_content.id,            content_type=step_content.content_type,            content_name=step_content.content_name,            content_desc=step_content.content_desc,            content_result=True,            content_step=step_index,            interface_case_result_id=interface_case_result_id,            interface_task_result_id=interface_task_result_id,            starter_id=starter.userId,            script_extracts=script_vars,            starter_name=starter.username,        )        await InterfaceContentStepResultMapper.insert(result)    @staticmethod    async def set_case_step_content_api_wait_result(            step_index: int,            interface_case_result_id: int,            step_content: InterfaceCaseStepContent,            starter: APIStarter,            interface_task_result_id: int = None,    ):        """        wait        """        result = InterfaceCaseStepContentResult(            content_id=step_content.id,            content_type=step_content.content_type,            content_name=step_content.content_name,            content_desc=step_content.content_desc,            content_step=step_index,            content_result=True,            interface_case_result_id=interface_case_result_id,            interface_task_result_id=interface_task_result_id,            starter_id=starter.userId,            wait_time=step_content.api_wait_time,            starter_name=starter.username,        )        await InterfaceContentStepResultMapper.insert(result)