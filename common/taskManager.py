#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2025/11/12# @Author : cyq# @File : taskManager# @Software: PyCharm# @Desc:from asyncio import Semaphore, Queue, create_taskfrom typing import Callable, Dict, Anyfrom utils import Tools, log, GenerateToolsclass TaskManager:    def __init__(self, semaphore: int = 5):        self.semaphore = Semaphore(semaphore)        self.queue = Queue()        self.is_consumer_running = False        self.running_tasks = {}    async def add_task(self, task_func: Callable, *args, **kwargs):        """        添加任务        """        task_id = GenerateTools.uid()        task_item = {            'task_id': task_id,            'task_func': task_func,            'args': args,            'kwargs': kwargs        }        log.info(f"TaskManager 添加任务: {task_item}")        await self.queue.put(task_item)        # 启动消费者（如果还没运行）        if not self.is_consumer_running:            create_task(self._task_consumer())            self.is_consumer_running = True        return task_id    async def _task_consumer(self):        """任务消费者，从队列中取出任务执行"""        while True:            log.info("=====_task_consumer")            task_item = await self.queue.get()            create_task(self._execute_task(task_item))    async def _execute_task(self, task_item:Dict[str,Any]):        """执行单个任务"""        task_id = task_item['task_id']        async with self.semaphore:            try:                self.running_tasks[task_id] = True                await task_item['task_func'](*task_item['args'], **task_item['kwargs'])            except Exception as e:                print(f"Task {task_id} failed: {e}")            finally:                self.running_tasks.pop(task_id, None)                self.queue.task_done()task_manager = TaskManager()