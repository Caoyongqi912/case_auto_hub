#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2025/12/16# @Author : cyq# @File : notify# @Software: PyCharm# @Desc: ç»“æœæ¨é€from dataclasses import dataclassfrom datetime import datetimeimport aiosmtplibfrom app.mapper.project.pushMapper import PushMapperfrom app.model.base import PushModelfrom common.httpxClient import HttpxClientfrom config import Configfrom enums import PushEnum, TaskResultfrom app.model.interface import InterfaceTaskResultModelfrom app.model.playUI import PlayTaskResultfrom typing import TypeVarfrom email.mime.multipart import MIMEMultipartfrom email.mime.text import MIMETextfrom utils import logResult = TypeVar('Result', bound=InterfaceTaskResultModel | PlayTaskResult)@dataclassclass NotifyInfo:    """    æ¨é€ç»“æœä¿¡æ¯    """    flag: str  # "API" | "UI"    result_id: int    result_uid: str    starter: str    result: TaskResult    task_name: str    task_id: int    task_uid: str    project_id: int    total: int    success: int    fail: int    use_time: str    start_time: str    end_time: strdef wework_template(notify: "NotifyInfo"):    """    ä¼ä¸šå¾®ä¿¡ ä¿¡æ¯æ¨¡ç‰ˆ    """    result_page_url = Config.report_url(target=notify.flag, result_id=notify.result_id)    task_page_url = Config.task_url(target=notify.flag, task_id=notify.task_id, project_id=notify.project_id)    if notify.result == TaskResult.FAIL:        result_info = "**ç»“æœ**ï¼š<font color=\"warning\">âŒ å¼‚å¸¸</font> [ç‚¹æˆ‘æŸ¥çœ‹è¯¦æƒ…]"    else:        result_info = "**ç»“æœ**ï¼š<font color=\"info\">âœ… é€šè¿‡</font> [ç‚¹æˆ‘æŸ¥çœ‹è¯¦æƒ…]"    result_info += result_page_url    _template = f"""              ## è‡ªåŠ¨åŒ–ä»»åŠ¡: <font> [{notify.task_name}]({task_page_url}) </font> æµ‹è¯•å®Œæˆ              > æ‰§è¡Œäºº: {notify.starter}              > æ‰§è¡Œç”¨æ—¶ï¼š{notify.use_time}              > æ‰§è¡Œç”¨ä¾‹æ•°é‡ï¼š{notify.total}              > æˆåŠŸï¼š{notify.success}              > å¤±è´¥ï¼š{notify.fail}              > {result_info}              """    return _templatedef email_template2(notify: "NotifyInfo"):    """    é‚®ä»¶ä¿¡æ¯æ¨¡ç‰ˆ    """    result_page_url = Config.report_url(target=notify.flag, result_id=notify.result_id)    task_page_url = Config.task_url(target=notify.flag, task_id=notify.task_id, project_id=notify.project_id)    Subject = f"è‡ªåŠ¨åŒ–ä»»åŠ¡: <font> [{notify.task_name}]({task_page_url}) </font> æµ‹è¯•å®Œæˆ"    if notify.result == TaskResult.FAIL:        Subject += f"âŒ å¼‚å¸¸"        result_info = "**ç»“æœ**ï¼š<font color=\"warning\">âŒ å¼‚å¸¸</font> [ç‚¹æˆ‘æŸ¥çœ‹è¯¦æƒ…]"    else:        Subject += "âœ… é€šè¿‡"        result_info = "**ç»“æœ**ï¼š<font color=\"info\">âœ… é€šè¿‡</font> [ç‚¹æˆ‘æŸ¥çœ‹è¯¦æƒ…]"    result_info += result_page_url    _template = f"""              ## è‡ªåŠ¨åŒ–ä»»åŠ¡: <font> [{notify.task_name}]({task_page_url}) </font> æµ‹è¯•å®Œæˆ              > æ‰§è¡Œäºº: {notify.starter}              > æ‰§è¡Œç”¨æ—¶ï¼š{notify.use_time}              > æ‰§è¡Œç”¨ä¾‹æ•°é‡ï¼š{notify.total}              > æˆåŠŸï¼š{notify.success}              > å¤±è´¥ï¼š{notify.fail}              > {result_info}              """    return _template, Subjectdef email_template(notify: "NotifyInfo"):    """    é‚®ä»¶ä¿¡æ¯æ¨¡ç‰ˆ - HTMLç‰ˆæœ¬    """    result_page_url = Config.report_url(target=notify.flag, result_id=notify.result_id)    task_page_url = Config.task_url(target=notify.flag, task_id=notify.task_id, project_id=notify.project_id)    # é‚®ä»¶ä¸»é¢˜    Subject = f"è‡ªåŠ¨åŒ–ä»»åŠ¡: [{notify.task_name}] æµ‹è¯•å®Œæˆ"    # åˆ¤æ–­ç»“æœçŠ¶æ€    if notify.result == TaskResult.FAIL:        result_text = "âŒ å¼‚å¸¸"        result_color = "#ff4d4f"  # çº¢è‰²        result_bg_color = "#fff2f0"        result_icon = "âŒ"    else:        result_text = "âœ… é€šè¿‡"        result_color = "#52c41a"  # ç»¿è‰²        result_bg_color = "#f6ffed"        result_icon = "âœ…"    # HTMLæ¨¡æ¿    html_template = f"""<!DOCTYPE html><html><head>    <meta charset="utf-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0"></head><body style="font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto;">    <div style="background: linear-gradient(135deg, #1890ff 0%, #096dd9 100%); padding: 20px; border-radius: 8px 8px 0 0;">        <h1 style="color: white; margin: 0; font-size: 24px;">            ğŸ¤– è‡ªåŠ¨åŒ–æµ‹è¯•ä»»åŠ¡é€šçŸ¥        </h1>    </div>    <div style="background: #fafafa; padding: 30px; border-radius: 0 0 8px 8px; border: 1px solid #e8e8e8; border-top: none;">        <!-- ä»»åŠ¡æ ‡é¢˜ -->        <div style="margin-bottom: 25px;">            <h2 style="margin: 0 0 10px 0; color: #1890ff; font-size: 20px;">                {notify.task_name}            </h2>            <p style="margin: 0; color: #666;">                ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ‰§è¡Œäºº: <strong>{notify.starter}</strong>            </p>        </div>        <!-- çŠ¶æ€å¡ç‰‡ -->        <div style="background: {result_bg_color}; border-left: 4px solid {result_color};                     padding: 15px; margin: 20px 0; border-radius: 4px;">            <div style="display: flex; align-items: center; gap: 10px;">                <span style="font-size: 24px;">{result_icon}</span>                <div>                    <h3 style="margin: 0; color: {result_color}; font-size: 18px;">                        {result_text}                    </h3>                    <p style="margin: 5px 0 0 0; color: #666;">                        æ‰§è¡Œç”¨æ—¶: <strong>{notify.use_time}</strong>                    </p>                </div>            </div>        </div>        <!-- ç»Ÿè®¡æ•°æ® -->        <div style="background: white; border: 1px solid #e8e8e8; border-radius: 8px; padding: 20px; margin: 20px 0;">            <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">                ğŸ“Š æ‰§è¡Œç»Ÿè®¡            </h3>            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">                <div style="text-align: center;">                    <div style="font-size: 28px; font-weight: bold; color: #1890ff;">                        {notify.total}                    </div>                    <div style="color: #666; font-size: 14px;">                        æ€»ç”¨ä¾‹æ•°                    </div>                </div>                <div style="text-align: center;">                    <div style="font-size: 28px; font-weight: bold; color: #52c41a;">                        {notify.success}                    </div>                    <div style="color: #666; font-size: 14px;">                        æˆåŠŸç”¨ä¾‹                    </div>                </div>                <div style="text-align: center;">                    <div style="font-size: 28px; font-weight: bold; color: #ff4d4f;">                        {notify.fail}                    </div>                    <div style="color: #666; font-size: 14px;">                        å¤±è´¥ç”¨ä¾‹                    </div>                </div>                <div style="text-align: center;">                    <div style="font-size: 28px; font-weight: bold; color: #faad14;">                        {notify.success_rate if hasattr(notify, 'success_rate') else round(notify.success / notify.total * 100, 1) if notify.total > 0 else 0}%                    </div>                    <div style="color: #666; font-size: 14px;">                        æˆåŠŸç‡                    </div>                </div>            </div>        </div>        <!-- æ“ä½œæŒ‰é’® -->        <div style="margin: 30px 0; text-align: center;">            <a href="{result_page_url}"                style="display: inline-block; background: #1890ff; color: white;                       text-decoration: none; padding: 12px 30px; border-radius: 6px;                       font-weight: bold; margin-right: 10px;">               ğŸ” æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š            </a>            <a href="{task_page_url}"                style="display: inline-block; background: #f0f0f0; color: #333;                       text-decoration: none; padding: 12px 30px; border-radius: 6px;                       font-weight: bold;">               ğŸ“‹ æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…            </a>        </div>        <!-- é¢å¤–ä¿¡æ¯ -->        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e8e8e8;">            <p style="margin: 0; color: #999; font-size: 14px;">                ğŸ’¡ æç¤º: æ­¤é‚®ä»¶ä¸ºç³»ç»Ÿè‡ªåŠ¨å‘é€ï¼Œè¯·å‹¿ç›´æ¥å›å¤ã€‚            </p>            <p style="margin: 10px 0 0 0; color: #999; font-size: 14px;">                â° å‘é€æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}            </p>        </div>    </div></body></html>    """    # åŒæ—¶ç”Ÿæˆçº¯æ–‡æœ¬ç‰ˆæœ¬ï¼ˆä¸ºä¸æ”¯æŒHTMLçš„é‚®ä»¶å®¢æˆ·ç«¯æä¾›ï¼‰    text_template = f"""            è‡ªåŠ¨åŒ–ä»»åŠ¡é€šçŸ¥            ==============                        ä»»åŠ¡åç§°: {notify.task_name}            æ‰§è¡Œäºº: {notify.starter}            æ‰§è¡Œç”¨æ—¶: {notify.use_time}            æ‰§è¡Œç»“æœ: {result_text}                        æ‰§è¡Œç»Ÿè®¡:            - æ€»ç”¨ä¾‹æ•°: {notify.total}            - æˆåŠŸç”¨ä¾‹: {notify.success}            - å¤±è´¥ç”¨ä¾‹: {notify.fail}                        æŸ¥çœ‹æŠ¥å‘Š: {result_page_url}            æŸ¥çœ‹ä»»åŠ¡: {task_page_url}                        å‘é€æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}            æ­¤é‚®ä»¶ä¸ºç³»ç»Ÿè‡ªåŠ¨å‘é€ï¼Œè¯·å‹¿ç›´æ¥å›å¤ã€‚"""    return html_template, text_template, Subjectclass NotifyManager:    def __init__(self, notify_id):        self.notify_id = notify_id        self.api_sender = HttpxClient()    async def push(self, flag: str, task_result: "Result"):        notify_info = NotifyInfo(flag=flag, **task_result.notify)        push_config = await PushMapper.get_by_id(self.notify_id)        T = push_config.push_type        match T:            case PushEnum.Email:                await self.to_email(notify_info, push_config)            case PushEnum.DingTalk:                pass            case PushEnum.WeWork:                await self.to_wechat(notify_info, push_config)    async def to_wechat(self, notify: "NotifyInfo", push_config: PushModel, ):        """        ä¼ä¸šå¾®ä¿¡å‘é€        """        _ = {            "msgtype": "markdown",            "markdown": {                "content": wework_template(notify)            }        }        response = await self.api_sender(url=Config.WeChatBaseUrl,                                         method="post",                                         params={"key": push_config.push_value},                                         json=_,                                         headers={"Content-Type": "application/json"})        if response.is_success:            log.info(f"[NotifyManager]:send wechat success")        else:            log.error(f"[NotifyManager]:send wechat fail")    async def to_email(self, notify: NotifyInfo, push_config: PushModel):        """        é‚®ç®±å‘é€        """        _html, _text, subject = email_template(notify)        # è®¾ç½®é‚®ä»¶å†…å®¹        msg = MIMEMultipart()        msg['From'] = Config.Email_Sender_Username        msg['To'] = push_config.push_value        msg['Subject'] = subject        html_part = MIMEText(_html, "html", "utf-8")        text_part = MIMEText(_text, "plain", "utf-8")        # åˆ›å»ºalternativeéƒ¨åˆ†ï¼ˆå®¢æˆ·ç«¯æ˜¾ç¤ºHTMLæˆ–çº¯æ–‡æœ¬ï¼‰        alternative = MIMEMultipart("alternative")        alternative.attach(text_part)        alternative.attach(html_part)        msg.attach(alternative)        import ssl        context = ssl.create_default_context()        context.check_hostname = False  # ä¸´æ—¶ç¦ç”¨ä¸»æœºåéªŒè¯è¿›è¡Œæµ‹è¯•ï¼ˆä¸æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼‰        context.verify_mode = ssl.CERT_NONE  # ä¸´æ—¶ç¦ç”¨è¯ä¹¦éªŒè¯ï¼ˆä¸æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼‰        try:            # å»ºç«‹å®‰å…¨è¿æ¥            async with aiosmtplib.SMTP(hostname=Config.Smtp_Server,                                       tls_context=context) as server:                # server.starttls()  # å¯ç”¨ TLS åŠ å¯†                # server.set_debuglevel(1)  # å¯ç”¨è°ƒè¯•è¾“å‡º                await server.login(Config.Email_Sender_Username, Config.Email_Sender_Password)  # ç™»å½•åˆ°é‚®ä»¶æœåŠ¡å™¨                await server.send_message(msg)            log.info("[NotifyManager]: send email success")        except Exception as e:            log.error(f"[NotifyManager] send email error : {e}")